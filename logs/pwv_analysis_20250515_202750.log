[INFO] 2025-05-15 20:27:50 - ==============================================
[INFO] 2025-05-15 20:27:50 - PWV数据分析工具 - 运行脚本
[INFO] 2025-05-15 20:27:50 - 基于小米可穿戴设备进行动脉硬化筛查与脑卒中风险预测研究
[INFO] 2025-05-15 20:27:50 - ==============================================
[INFO] 2025-05-15 20:27:50 - 检测到虚拟环境venv
[INFO] 2025-05-15 20:27:50 - 检测到pyenv，切换到Python 3.12.9...
[SUCCESS] 2025-05-15 20:27:50 - 使用Python: Python 3.12.9
[SUCCESS] 2025-05-15 20:27:50 - 使用Python: Python 3.12.9
[INFO] 2025-05-15 20:27:50 - 激活虚拟环境...
[SUCCESS] 2025-05-15 20:27:50 - 虚拟环境已激活
[INFO] 2025-05-15 20:27:50 - 记录虚拟环境包信息...
cloudpickle==3.1.1
contourpy==1.3.2
cycler==0.12.1
et_xmlfile==2.0.0
fonttools==4.58.0
joblib==1.5.0
kaleido==0.2.1
kiwisolver==1.4.8
llvmlite==0.44.0
lxml==5.4.0
Markdown==3.8
matplotlib==3.10.3
narwhals==1.39.0
numba==0.61.2
numpy==2.2.5
nvidia-nccl-cu12==2.26.5
openpyxl==3.1.5
packaging==25.0
pandas==2.2.3
patsy==1.0.1
pillow==11.2.1
plotly==6.0.1
# Editable Git install with no remote (pwv_analysis==2.0.0)
-e /home/alfred/renminandxiaomi
pyparsing==3.2.3
python-dateutil==2.9.0.post0
python-docx==1.1.2
pytz==2025.2
scikit-learn==1.6.1
scipy==1.15.3
seaborn==0.13.2
shap==0.47.2
six==1.17.0
slicer==0.0.8
statsmodels==0.14.4
threadpoolctl==3.6.0
tqdm==4.67.1
typing_extensions==4.13.2
tzdata==2025.2
xgboost==3.0.1
[INFO] 2025-05-15 20:27:50 - 分析脚本检查通过
[INFO] 2025-05-15 20:27:50 - ==============================================
[INFO] 2025-05-15 20:27:50 - 开始运行PWV数据分析流程...
[INFO] 2025-05-15 20:27:50 - 注意: 这个过程可能需要几分钟时间，请耐心等待...
[INFO] 2025-05-15 20:27:50 - ==============================================
2025-05-15 20:27:51,437 - INFO - 检测到WSL环境，将尝试使用Windows字体
2025-05-15 20:27:51,438 - INFO - 找到Windows字体目录: /mnt/c/Windows/Fonts
2025-05-15 20:27:51,439 - INFO - 找到Windows中文字体: /mnt/c/Windows/Fonts/simhei.ttf
2025-05-15 20:27:51,442 - INFO - 图表样式增强设置完成
2025-05-15 20:27:51,492 - INFO - 检测到WSL2环境
2025-05-15 20:27:51,492 - INFO - WSL2环境：尝试访问Windows字体目录
2025-05-15 20:27:51,492 - INFO - 找到Windows字体目录: /mnt/c/Windows/Fonts
2025-05-15 20:27:51,492 - INFO - 找到Windows中文字体: /mnt/c/Windows/Fonts/simhei.ttf
2025-05-15 20:27:51,555 - INFO - 成功使用WSL下的Windows字体: SimHei
2025-05-15 20:27:51,555 - INFO - 图表样式增强设置完成
2025-05-15 20:27:51,555 - INFO - 检测到WSL环境，将尝试使用Windows字体
2025-05-15 20:27:51,556 - INFO - 找到Windows字体目录: /mnt/c/Windows/Fonts
2025-05-15 20:27:51,556 - INFO - 找到Windows中文字体: /mnt/c/Windows/Fonts/simhei.ttf
2025-05-15 20:27:51,568 - INFO - 检测到WSL环境，将尝试使用Windows字体
2025-05-15 20:27:51,568 - INFO - 找到Windows字体目录: /mnt/c/Windows/Fonts
2025-05-15 20:27:51,568 - INFO - 找到Windows中文字体: /mnt/c/Windows/Fonts/simhei.ttf
2025-05-15 20:27:51,568 - INFO - 图表样式增强设置完成
🚀 PWV数据分析流程启动于: 2025-05-15 20:27:51
============================================================
ℹ️ 当前工作目录: /home/alfred/renminandxiaomi
ℹ️ 项目根目录: /home/alfred/renminandxiaomi

创建输出目录...
✅ 主要输出目录已在 'output' 下创建/确认。

-------------------- 步骤1: 数据加载与预处理 --------------------

==================== 数据加载和预处理 ====================
找到最新数据文件: docs/excel/pwv数据采集表 -去公式.xlsx
正在加载数据文件: docs/excel/pwv数据采集表 -去公式.xlsx
成功加载数据: 222 行, 77 列

开始数据清洗...
列 'cfPWV-颈动脉-SI ' 中的特殊值已替换为NaN
列 'cfPWV-颈动脉-RI ' 中的特殊值已替换为NaN
列 '尿素（mmol/L）' 中的逗号已替换为小数点
检测到重复的性别列，已删除'性别'列，保留'受试者-性别'列
已重命名列: {'基础信息-年龄': 'age', '受试者-性别': 'gender', '基础信息-身高': 'height', '基础信息-体重': 'weight', '竞品信息-脉搏波传导速度': 'pwv', 'cfPWV-速度m/s': 'cfpwv_速度', 'baPWV-右侧-速度m/s': 'bapwv_右侧_速度', 'baPWV-左侧-速度m/s': 'bapwv_左侧_速度'}
列 'age' 转换为数值: 222 非空值 -> 222 非空值
列 'height' 转换为数值: 222 非空值 -> 222 非空值
列 'weight' 转换为数值: 222 非空值 -> 222 非空值
列 'pwv' 转换为数值: 221 非空值 -> 221 非空值
列 'cfpwv_速度' 转换为数值: 206 非空值 -> 206 非空值
列 'bapwv_右侧_速度' 转换为数值: 213 非空值 -> 213 非空值
列 'bapwv_左侧_速度' 转换为数值: 212 非空值 -> 212 非空值
列 '收缩压' 转换为数值: 222 非空值 -> 222 非空值
列 '舒张压' 转换为数值: 222 非空值 -> 222 非空值
列 'cfPWV-颈动脉-SI ' 转换为数值: 222 非空值 -> 131 非空值
列 'cfPWV-颈动脉-RI ' 转换为数值: 222 非空值 -> 129 非空值
删除PWV值缺失的行后，剩余 221 行
列 'cfpwv_速度' 缺失值已用中位数 9.25 填充
列 'bapwv_右侧_速度' 缺失值已用中位数 11.10 填充
列 'bapwv_左侧_速度' 缺失值已用中位数 11.30 填充
列 'cfPWV-颈动脉-SI ' 缺失值已用中位数 9.62 填充
列 'cfPWV-颈动脉-RI ' 缺失值已用中位数 0.42 填充
列 'cfPWV-颈动脉-DAIX ' 缺失值已用中位数 0.57 填充
列 'cfPWV-时间间隔ms' 缺失值已用中位数 78.00 填充
列 'cfPWV-距离cm' 缺失值已用中位数 72.00 填充
列 'cfPWV-股动脉-SI ' 缺失值已用中位数 5.33 填充
列 'cfPWV-股动脉-RI' 缺失值已用中位数 0.02 填充
列 'cfPWV-股动脉-DAIX ' 缺失值已用中位数 0.99 填充
列 'baPWV-右侧-距离cm' 缺失值已用中位数 110.00 填充
列 'baPWV-右侧-时间间隔ms' 缺失值已用中位数 92.00 填充
列 'baPWV-左侧-距离cm' 缺失值已用中位数 110.00 填充
列 'baPWV-左侧-时间间隔ms' 缺失值已用中位数 90.00 填充
缺失值处理：4561 -> 3999
标准化性别编码...
性别分布: 
gender
0    117
1    104
Name: count, dtype: int64
计算BMI...
BMI计算完成，平均BMI: 24.84
BMI离群值处理: 替换了 0 个异常值
列 '收缩压' 中的 1 个异常值已替换为中位数 128.00
已创建脉压差列
已删除 1 个全为NaN的列: ['其他']

数据清洗完成: 222 行 -> 221 行 (99.5% 保留)

开始创建派生特征...
已创建年龄段特征
已创建血压分类特征，分布: 
bp_category
正常血压     55
1级高血压    54
正常高值     50
高值血压     47
2级高血压     8
低血压       4
3级高血压     3
Name: count, dtype: int64
已创建PWV分类特征，分布: 
pwv_category
偏高    98
边缘    82
正常    41
Name: count, dtype: int64
已创建总风险得分，平均值: 1.77
已创建风险等级特征
已添加cfPWV标记列
已添加baPWV标记列
派生特征创建完成，现有特征总数: 89

数据摘要:
- 数据形状: (221, 89) (行 x 列)
- age 平均值: 58.67
- bmi 平均值: 24.84
- pwv 平均值: 9.50
- PWV 平均值: 9.50, 中位数: 9.70
- PWV 性别差异: 女性 9.54±1.88 vs 男性 9.45±1.64

数据已准备完成，可以开始分析
✅ 数据加载和预处理完成。
  加载数据形状: (221, 89)

-------------------- 步骤2: 基础数据分析 --------------------

======== 开始PWV数据分析 ========

计算基本统计指标...
基本统计指标计算完成

分析性别差异...
性别差异分析完成

分析年龄组差异...
注意: 未找到'年龄组'列，尝试创建...
年龄组分析完成

计算变量相关性...
相关性分析完成

执行PWV回归分析...
PWV回归分析完成

检测异常值...
异常值检测完成

======== PWV数据分析完成 ========
✅ 基础数据分析完成。

保存分析结果到 output/tables/PWV_Core_Analysis_Results.xlsx...
  已保存 'basic_stats' 到工作表 'basic_stats'
  已保存 'gender_comparison' 到工作表 'gender_comparison'
  已保存 'age_group_stats' 到工作表 'age_group_stats'
  已保存 'age_group_anova' 到工作表 'age_group_anova'
  已保存 'correlation_analysis' 到工作表 'correlation_analysis'
  已保存 'pwv_regression' 到工作表 'pwv_regression'
  已保存 'pwv_model_stats' 到工作表 'pwv_model_stats'
✅ 分析结果已保存到: output/tables/PWV_Core_Analysis_Results.xlsx
  核心分析结果已保存到: output/tables/PWV_Core_Analysis_Results.xlsx

-------------------- 步骤3: 高级数据分析 --------------------

开始执行高级分析...

BMI分类统计:
bmi分类
偏瘦     7
正常    88
超重    89
肥胖    37
Name: count, dtype: int64

BMI分类百分比:
bmi分类
偏瘦     3.167421
正常    39.819005
超重    40.271493
肥胖    16.742081
Name: proportion, dtype: float64

血压状态分类统计:
血压状态
正常血压      59
正常高值     125
高血压1级     36
高血压2级      1
Name: count, dtype: int64

血压状态分类百分比:
血压状态
正常血压     26.696833
正常高值     56.561086
高血压1级    16.289593
高血压2级     0.452489
Name: proportion, dtype: float64

按 bmi分类 进行子群体分析...

bmi分类子群体统计描述:
            pwv                             ...        age                         
           mean       std count  min   max  ...       mean        std count min max
bmi分类                                       ...                                    
偏瘦     8.042857  1.695934     7  6.3  11.2  ...  42.714286  21.437617     7  22  78
正常     9.378409  1.758686    88  6.3  12.5  ...  58.352273  15.993562    88  25  84
超重     9.702247  1.764098    89  6.8  13.3  ...  60.370787  14.986647    89  25  89
肥胖     9.564865  1.704278    37  6.4  12.3  ...  58.351351  16.784941    37  18  83

[4 rows x 20 columns]

age 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj   lower    upper  reject
0     偏瘦     正常   15.6380  0.0622 -0.5369  31.8129   False
1     偏瘦     肥胖   15.6371  0.0830 -1.3394  32.6135   False
2     偏瘦     超重   17.6565  0.0262  1.4883  33.8247    True
3     正常     肥胖   -0.0009  1.0000 -8.0711   8.0693   False
4     正常     超重    2.0185  0.8333 -4.1733   8.2104   False
5     肥胖     超重    2.0194  0.9158 -6.0373  10.0762   False

组间差异检验结果:
    变量   检验类型       统计量        P值
0  pwv  ANOVA  2.171716  0.092303
1  收缩压  ANOVA  1.428282  0.235425
2  舒张压  ANOVA  1.863321  0.136747
3  age  ANOVA  2.702926  0.046444

按 血压状态 进行子群体分析...

血压状态子群体统计描述:
             pwv                        ...        age              
            mean       std count   min  ...        std count min max
血压状态                                    ...                         
正常血压    8.393220  1.530367    59   6.3  ...  16.265567    59  22  84
正常高值    9.800800  1.651856   125   6.4  ...  15.523863   125  18  89
高血压1级  10.177778  1.711993    36   7.1  ...  12.069902    36  35  78
高血压2级  12.300000       NaN     1  12.3  ...        NaN     1  77  77

[4 rows x 20 columns]

pwv 的事后多重比较 (Tukey HSD):2025-05-15 20:27:55,394 - INFO - Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.
2025-05-15 20:27:55,396 - INFO - Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.

  group1 group2  meandiff   p-adj   lower   upper  reject
0   正常血压   正常高值    1.4076  0.0000  0.7409  2.0743    True
1   正常血压  高血压1级    1.7846  0.0000  0.8919  2.6772    True
2   正常血压  高血压2级    3.9068  0.0847 -0.3498  8.1634   False
3   正常高值  高血压1级    0.3770  0.6133 -0.4214  1.1754   False
4   正常高值  高血压2级    2.4992  0.4232 -1.7386  6.7370   False
5  高血压1级  高血压2级    2.1222  0.5741 -2.1570  6.4014   False

收缩压 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj    lower    upper  reject
0   正常血压   正常高值   23.2018  0.0000  18.6979  27.7056    True
1   正常血压  高血压1级   38.6069  0.0000  32.5765  44.6372    True
2   正常血压  高血压2级   52.7458  0.0000  23.9912  81.5003    True
3   正常高值  高血压1级   15.4051  0.0000  10.0117  20.7985    True
4   正常高值  高血压2级   29.5440  0.0402   0.9162  58.1718    True
5  高血压1级  高血压2级   14.1389  0.5854 -14.7684  43.0462   False

舒张压 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj    lower    upper  reject
0   正常血压   正常高值    9.2895  0.0000   5.4790  13.1000    True
1   正常血压  高血压1级   11.6139  0.0000   6.5119  16.7159    True
2   正常血压  高血压2级   -6.8305  0.8862 -31.1584  17.4974   False
3   正常高值  高血压1级    2.3244  0.5519  -2.2387   6.8876   False
4   正常高值  高血压2级  -16.1200  0.3142 -40.3406   8.1006   False
5  高血压1级  高血压2级  -18.4444  0.2095 -42.9015   6.0127   False

age 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj    lower    upper  reject
0   正常血压   正常高值   10.9769  0.0000   4.7491  17.2048    True
1   正常血压  高血压1级   14.4614  0.0001   6.1228  22.8000    True
2   正常血压  高血压2级   27.0169  0.2960 -12.7442  66.7781   False
3   正常高值  高血压1级    3.4844  0.6214  -3.9734  10.9423   False
4   正常高值  高血压2级   16.0400  0.7207 -23.5458  55.6258   False
5  高血压1级  高血压2级   12.5556  0.8482 -27.4167  52.5279   False

组间差异检验结果:
    变量   检验类型         统计量            P值
0  pwv  ANOVA   13.539320  3.942220e-08
1  收缩压  ANOVA  105.503815  3.719014e-42
2  舒张压  ANOVA   17.280373  4.245513e-10
3  age  ANOVA    9.549573  5.972170e-06

执行统计功效分析: pwv by gender...

功效分析结果:
   目标功效  效应量 (Cohen's d)  当前样本量  达到目标功效所需样本量   当前统计功效
0  0.80         0.050185    221        12511  0.06589
1  0.85         0.050185    221        14311  0.06589
2  0.90         0.050185    221        16748  0.06589
3  0.95         0.050185    221        20712  0.06589

执行聚类分析...

聚类分析结果:
          age                         bmi  ...   舒张压        pwv                
         mean        std count       mean  ... count       mean       std count
聚类                                         ...                                 
0   70.945652   5.616624    92  24.592882  ...    92  10.917391  1.041091    92
1   39.878788  11.845824    66  24.142774  ...    66   7.643939  0.898739    66
2   60.428571  11.082847    63  25.920216  ...    63   9.366667  1.392839    63

[3 rows x 15 columns]

聚类占比(%):
聚类
0    41.628959
1    29.864253
2    28.506787
Name: proportion, dtype: float64

聚类特征描述:
   聚类  样本数      占比(%)              显著特征
0   0   92  41.628959  收缩压高, 舒张压高, age高
1   1   66  29.864253  收缩压低, 舒张压低, age低
2   2   63  28.506787  age低, bmi低, 收缩压低

执行PWV参考值比较分析...

PWV与参考值比较结果:
     年龄组  样本数      PWV均值    PWV标准差  ...  参考上限  低于参考范围(%)   在参考范围内(%)  高于参考范围(%)
0    <30   20   7.540000  1.249168  ...   8.0   0.000000   80.000000  20.000000
1  30-39   12   7.391667  0.516031  ...   8.5   0.000000  100.000000   0.000000
2  40-49   28   7.582143  0.527084  ...   9.0   7.142857   92.857143   0.000000
3  50-59   28   8.303571  0.725454  ...  10.0  35.714286   64.285714   0.000000
4  60-69   65   9.889231  0.960001  ...  11.5  13.846154   83.076923   3.076923
5    70+   68  11.351471  0.908253  ...  13.0   2.941176   94.117647   2.941176

[6 rows x 11 columns]

高级分析完成！
✅ 高级数据分析完成。
  高级分析结果已保存到: output/tables/PWV_Advanced_Analysis_Results.xlsx

-------------------- 步骤4: 临床风险分析 --------------------

开始执行临床分析...

执行PWV风险分类...

PWV风险分类统计:
PWV风险
正常      213
边缘        6
显著风险      2
Name: count, dtype: int64

PWV风险分类百分比:
PWV风险
正常      96.380090
边缘       2.714932
显著风险     0.904977
Name: proportion, dtype: float64

计算综合风险评分...

综合风险评分统计:
count    221.000000
mean       3.529412
std        1.848290
min        0.000000
25%        2.500000
50%        3.500000
75%        5.000000
max        8.000000
Name: 综合风险评分, dtype: float64

综合风险等级统计:
综合风险等级
中等风险    96
高风险     52
低风险     44
极高风险    20
Name: count, dtype: int64

综合风险等级百分比:
综合风险等级
中等风险    45.283019
高风险     24.528302
低风险     20.754717
极高风险     9.433962
Name: proportion, dtype: float64

计算10年心血管疾病风险评分...

10年CVD风险统计:
count    221.000000
mean       4.490498
std        2.539318
min        1.000000
25%        2.300000
50%        4.700000
75%        6.700000
max       13.300000
Name: 10年CVD风险(%), dtype: float64

CVD风险等级统计:
CVD风险等级
低风险     140
中等风险     77
高风险       4
极高风险      0
Name: count, dtype: int64

CVD风险等级百分比:
CVD风险等级
低风险     63.348416
中等风险    34.841629
高风险      1.809955
极高风险     0.000000
Name: proportion, dtype: float64

年龄组与CVD风险等级交叉分析 (%):
CVD风险等级         低风险       中等风险       高风险
年龄组                                     
<30      100.000000   0.000000  0.000000
30-39    100.000000   0.000000  0.000000
40-49    100.000000   0.000000  0.000000
50-59     96.428571   3.571429  0.000000
60-69     58.461538  41.538462  0.000000
70+       22.058824  72.058824  5.882353

高风险人群特征分析:
             age  gender        bmi         收缩压       舒张压        pwv
count   4.000000     4.0   4.000000    4.000000   4.00000   4.000000
mean   78.750000     1.0  25.967423  146.750000  73.50000  12.150000
std     6.849574     0.0   0.522743    7.041543   7.72442   0.866025
min    75.000000     1.0  25.259516  141.000000  69.00000  11.000000
25%    75.000000     1.0  25.743111  143.250000  69.00000  11.900000
50%    75.500000     1.0  26.081947  144.500000  70.00000  12.250000
75%    79.250000     1.0  26.306259  148.000000  74.50000  12.500000
max    89.000000     1.0  26.446281  157.000000  85.00000  13.100000

临床分析完成！
✅ 临床风险分析完成。
  临床分析结果已保存到: output/tables/PWV_Clinical_Analysis_Results.xlsx

-------------------- 步骤5: 基础数据可视化 --------------------

======== 开始生成数据可视化 ========
✅ 输出目录已创建/确认

绘制分布直方图...
- 已保存 pwv 分布图: output/figures/distribution/distribution_pwv.png
- 已保存 age 分布图: output/figures/distribution/distribution_age.png
- 已保存 收缩压 分布图: output/figures/distribution/distribution_收缩压.png
- 已保存 舒张压 分布图: output/figures/distribution/distribution_舒张压.png
- 已保存 bmi 分布图: output/figures/distribution/distribution_bmi.png
- 已保存 height 分布图: output/figures/distribution/distribution_height.png
- 已保存 weight 分布图: output/figures/distribution/distribution_weight.png

绘制箱线图...
  已保存: overall_boxplot.png
  已保存: pwv_by_gender_boxplot.png
Traceback (most recent call last):
  File "/home/alfred/renminandxiaomi/scripts/model_visualization_utils.py", line 483, in visualize_shap_values
    shap.waterfall_plot(
TypeError: waterfall() got an unexpected keyword argument 'text_kwargs'
Traceback (most recent call last):
  File "/home/alfred/renminandxiaomi/scripts/model_visualization_utils.py", line 610, in visualize_shap_values
    shap.force_plot(
TypeError: force() got an unexpected keyword argument 'text_kwargs'
  已保存: pwv_by_年龄组_boxplot.png
  已保存: pwv_by_bmi分类_boxplot.png
  已保存: pwv_by_血压状态_boxplot.png

绘制相关性热力图...
  已保存: correlation_heatmap.png
  已保存: correlation_clustermap.png

绘制性别差异图...
  已保存: pwv_gender_comparison.png
  已保存: age_gender_comparison.png
  已保存: 收缩压_gender_comparison.png
  已保存: 舒张压_gender_comparison.png
  已保存: bmi_gender_comparison.png
  已保存: height_gender_comparison.png
  已保存: weight_gender_comparison.png

绘制年龄组分析图...
  已保存: pwv_by_age_group_boxplot.png
  已保存: pwv_by_age_group_trend.png
  已保存: age_group_distribution.png

绘制PWV回归分析图...
  已保存: pwv_age_regression.png
  已保存: pwv_收缩压_regression.png
  已保存: pwv_舒张压_regression.png
  已保存: pwv_bmi_regression.png
  已保存: pwv_age_gender_regression.png

======== 数据可视化完成，共生成 29 个图表 ========
图表已按类型保存在 output/figures 各子目录中
✅ 基础数据可视化完成，共生成 29 个图表。
  图表保存在: output/image

-------------------- 步骤6: 增强数据可视化 --------------------

开始创建增强可视化图表...

创建高级热力图: pwv by age & bmi

创建高级热力图: pwv by 收缩压 & 舒张压

创建高级热力图: 收缩压 by age & pwv

创建风险评估可视化...

创建子群体可视化...

共创建了 27 个增强可视化图表，保存在 output/image 目录中
✅ 增强数据可视化完成，共生成 27 个图表。
  图表保存在: output/image

-------------------- 步骤7: 风险预测分析 --------------------

==== 开始风险预测: PWV超标风险 ====

准备特征和目标变量 (目标: cfpwv_速度)...
将数值目标转换为二分类 (阈值: 10.0)
分类分布: 0 (低风险): 152, 1 (高风险): 69
创建衍生特征以增强风险预测...
已创建'脉压'特征
已创建'平均动脉压'特征
已创建'年龄_平方'特征
已创建'年龄分组'特征
已创建'bmi_分类'特征
已创建'体重分组'特征
已创建'血压_分类'特征
已创建'年龄收缩压_交互'特征
已创建'bmi收缩压_交互'特征
创建了 9 个新特征
自动选择了 75 个特征
特征形状: (221, 75), 目标形状: (221,)
目标类型: 分类
特征列: 受试者-编号, gender, height, weight, age, 收缩压, 舒张压, pwv, 竞品信息-心率变异性, cfPWV-颈动脉-SI , cfPWV-颈动脉-RI , cfPWV-颈动脉-DAIX , cfPWV-距离cm, cfPWV-股动脉-SI , cfPWV-股动脉-RI, cfPWV-股动脉-DAIX , baPWV-右侧-距离cm, bapwv_右侧_速度, baPWV-左侧-距离cm, bapwv_左侧_速度, ABI-右侧-肱血压, ABI-右侧-肱指数, ABI-右侧-足背血压, ABI-右侧-足背指数, ABI-右侧-胫后血压, ABI-右侧-胫后指数, ABI-左侧-肱血压, ABI-左侧-肱指数, ABI-左侧-足背血压, ABI-左侧-足背指数, ABI-左侧-胫后血压, ABI-左侧-胫后指数, 血流速度-颈部-最高速度m/s, 血流速度-颈部-最低速度m/s, 血流速度-颈部-平均速度m/s, 血流速度-腕部-最高速度m/s, 血流速度-腕部-最低速度m/s, 血流速度-腕部-平均速度m/s, CRP（mg/L）, PCT（ng/ml）, TnI（pg/ml）, CK-MB（ng/ml）, 肌红蛋白（ng/ml）, BNP（pg/ml）, 肌酐（umol/L）, WBC(10^9), RBC(10^9), Hb（g/L）, PLT(10^9), PT, APTT, D-dimer, 射血分数（%）, bmi, 脉压差, age_risk, sbp_risk, gender_risk, bmi_risk, pwv_risk, risk_score, has_cfpwv, has_bapwv, 基础风险分数, 血压评分, PWV评分, 脉压, 平均动脉压, 年龄_平方, 血压_分类, 年龄收缩压_交互, bmi收缩压_交互, 年龄分组, 体重分组, bmi_分类
警告: 33 个特征含有缺失值，模型训练时将进行处理
ABI-右侧-肱血压          18
ABI-右侧-肱指数          18
ABI-右侧-足背血压         17
ABI-右侧-足背指数         17
ABI-右侧-胫后血压         13
ABI-右侧-胫后指数         13
ABI-左侧-肱血压          11
ABI-左侧-肱指数          12
ABI-左侧-足背血压         17
ABI-左侧-足背指数         17
ABI-左侧-胫后血压         12
ABI-左侧-胫后指数         12
血流速度-颈部-最高速度m/s     54
血流速度-颈部-最低速度m/s     55
血流速度-颈部-平均速度m/s     56
血流速度-腕部-最高速度m/s     25
血流速度-腕部-最低速度m/s     25
血流速度-腕部-平均速度m/s     25
CRP（mg/L）          131
PCT（ng/ml）         131
TnI（pg/ml）         131
CK-MB（ng/ml）       131
肌红蛋白（ng/ml）        131
BNP（pg/ml）         131
肌酐（umol/L）         131
WBC(10^9)          131
RBC(10^9)          131
Hb（g/L）            131
PLT(10^9)          131
PT                 131
APTT               131
D-dimer            131
射血分数（%）            131
dtype: int64
训练集: (165, 75), 测试集: (56, 75)
选择的模型类型: xgboost_classifier
检测到 1823 个缺失值，将进行处理
任务类型: 二分类, 样本数: 165
训练集: 132样本, 验证集: 33样本
创建XGBoost二分类模型
正在训练模型...
训练集准确率: 1.0000, 验证集准确率: 0.6667
警告: 可能存在过拟合
模型训练完成
在 测试集 上的评估指标 (PWV超标风险): {'accuracy': 0.625, 'f1': 0.36363636363636365, 'precision': 0.375, 'recall': 0.35294117647058826, 'roc_auc': np.float64(0.6711915535444947)}

可视化模型 'PWV超标风险' 的性能...
ROC曲线已保存: output/image/风险预测/PWV超标风险/PWV超标风险_roc_curve.png
PR曲线已保存: output/image/风险预测/PWV超标风险/PWV超标风险_pr_curve.png
混淆矩阵已保存: output/image/风险预测/PWV超标风险/PWV超标风险_confusion_matrix.png

准备SHAP解释器和计算SHAP值...
使用TreeExplainer for XGBoost模型
正在计算SHAP值...
SHAP值计算完成。
SHAP值数组形状: (56, 75)
DEBUG: run_risk_prediction - About to call visualize_shap_values for PWV超标风险
  X_shap_sample.shape: (56, 75)
  X_shap_sample is DataFrame, empty: False
DEBUG: Entering visualize_shap_values for model: PWV超标风险
  Initial X_sample shape: (56, 75)
  Initial X_sample is DataFrame, empty: False
  DEBUG_SHAP_CHECK: SHAP_AVAILABLE: True, explainer is None: False, shap_values is None: False
DEBUG: Set plt.rcParams['font.sans-serif'] to: ['SimHei', 'Arial', 'Liberation Sans', 'DejaVu Sans', 'Bitstream Vera Sans', 'sans-serif']

生成SHAP值可视化 for PWV超标风险...
  DEBUG: X_sample is already a DataFrame.
  DEBUG: X_sample_df defined. Is None: False
  X_sample_df shape after processing: (56, 75)
SHAP摘要图 (Beeswarm) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_summary_beeswarm.png
SHAP条形图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_summary_bar.png
错误: 生成SHAP瀑布图失败: waterfall() got an unexpected keyword argument 'text_kwargs'
SHAP依赖图 (年龄收缩压_交互) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_年龄收缩压_交互.png
SHAP依赖图 (age) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_age.png
SHAP依赖图 (bapwv_右侧_速度) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_bapwv_右侧_速度.png
SHAP依赖图 (ABI-右侧-胫后血压) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_ABI-右侧-胫后血压.png
SHAP依赖图 (pwv) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_pwv.png
DEBUG: Before Individual Force Plot:
  shap_values_sample_for_plot is None: False
  shap_values_sample_for_plot.shape: (75,)
  current_base_value_for_sample is None: False
  current_base_value_for_sample: -0.7533249258995056
  type(current_base_value_for_sample): <class 'numpy.float32'>
  X_sample_df.shape: (56, 75)
错误: 生成SHAP力图 (样本 0) 失败: force() got an unexpected keyword argument 'text_kwargs'
DEBUG: Before Multiple Samples HTML Force Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 75)
  expected_value_for_html_force is None: False2025-05-15 20:28:09,477 - INFO - ============================== 开始生成所有报告 ==============================
2025-05-15 20:28:09,477 - INFO - ✅ 主要输出目录已在 'output' 下创建/确认。
2025-05-15 20:28:09,478 - INFO - 📝 开始生成结构化报告元素...
2025-05-15 20:28:09,480 - INFO - 报告元素列表组合完毕，共 149 个元素。
2025-05-15 20:28:09,480 - INFO - 📄 结构化报告元素生成完毕，共 149 个元素。
2025-05-15 20:28:09,480 - INFO - 🔄 正在生成Markdown报告: output/reports/PWV数据分析综合报告.md...
2025-05-15 20:28:09,480 - INFO - ✅ Markdown报告已保存至: output/reports/PWV数据分析综合报告.md
2025-05-15 20:28:09,481 - INFO - ✅ Markdown报告已保存至: output/reports/PWV数据分析综合报告.md
2025-05-15 20:28:09,481 - INFO - 🔄 从 output/reports/PWV数据分析综合报告.md 提取表格数据到Excel: output/tables/PWV数据分析报告_表格汇总.xlsx...
2025-05-15 20:28:09,481 - INFO - 从Markdown文件 'output/reports/PWV数据分析综合报告.md' 提取表格...
2025-05-15 20:28:09,481 - WARNING - 在Markdown文件 'output/reports/PWV数据分析综合报告.md' 中未找到表格。
2025-05-15 20:28:09,484 - INFO - ✅ 成功提取表格到: output/tables/PWV数据分析报告_表格汇总.xlsx
2025-05-15 20:28:09,484 - INFO - 🔄 正在将结构化元素转换为HTML文档: output/reports/PWV数据分析综合报告.html...
2025-05-15 20:28:09,484 - INFO - [Placeholder] HTML渲染器调用: output/reports/PWV数据分析综合报告.html
2025-05-15 20:28:09,484 - INFO - ✅ HTML报告已保存至: output/reports/PWV数据分析综合报告.html
2025-05-15 20:28:09,485 - INFO - 🔄 正在将结构化元素转换为Word文档: output/reports/PWV数据分析综合报告.docx...
2025-05-15 20:28:09,485 - INFO - [Placeholder] Word渲染器调用: output/reports/PWV数据分析综合报告.docx
2025-05-15 20:28:09,485 - INFO - ✅ Word报告已保存至: output/reports/PWV数据分析综合报告.docx
2025-05-15 20:28:09,485 - INFO - ============================== 所有报告生成完毕 ==============================
2025-05-15 20:28:09,485 - INFO - Markdown报告: output/reports/PWV数据分析综合报告.md
2025-05-15 20:28:09,485 - INFO - Excel表格: output/tables/PWV数据分析报告_表格汇总.xlsx
2025-05-15 20:28:09,485 - INFO - HTML报告: output/reports/PWV数据分析综合报告.html
2025-05-15 20:28:09,485 - INFO - Word报告: output/reports/PWV数据分析综合报告.docx

  expected_value_for_html_force: -0.7533249258995056
  X_sample_df.shape: (56, 75)
SHAP力图 (多个样本) 已保存为HTML: output/image/风险预测/PWV超标风险/PWV超标风险_shap_force_multiple.html
DEBUG: Before Decision Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 75)
  current_base_value_for_sample is None: False
  current_base_value_for_sample for decision: -0.7533249258995056
  num_samples_for_decision_plot: 5
  X_sample_df.shape: (56, 75)
DEBUG: Inside Decision Plot try, before shape check:
  shap_values_for_decision.shape: (5, 75)
  features_for_decision.shape: (5, 75)
SHAP决策图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_decision_plot.png
DEBUG: Before Heatmap Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 75)
  X_sample_df.shape: (56, 75)
SHAP热力图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_heatmap.png
DEBUG: Before Interaction Plot:
  Calculating SHAP interaction values...
  SHAP interaction values calculated. Type: <class 'numpy.ndarray'>, Shape: (56, 75, 75)
SHAP交互值摘要条形图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_interaction_summary_bar.png
DEBUG: Restored plt.rcParams['font.sans-serif'] to: ['Arial', 'Liberation Sans', 'DejaVu Sans', 'Bitstream Vera Sans', 'sans-serif']
==== 完成风险预测: PWV超标风险 ====

✅ 风险预测分析完成。
  风险预测模型生成了 0 个图表。

-------------------- 步骤8: 生成分析报告 --------------------
尝试生成PWV数据分析综合报告...
✅ PWV数据分析综合报告成功生成，包含Markdown、Excel表格、Word和HTML格式。

============================================================
🎉 PWV数据分析流程全部完成! (总耗时: 17.82秒)
------------------------- 查看产出 -------------------------
- Excel表格 (核心分析): output/tables/PWV_Core_Analysis_Results.xlsx
- Excel表格 (高级分析): output/tables/PWV_Advanced_Analysis_Results.xlsx
- Excel表格 (临床分析): output/tables/PWV_Clinical_Analysis_Results.xlsx
- Excel表格 (风险预测): output/tables/PWV_Risk_Predictions.xlsx
- Excel表格 (从报告提取): output/tables/PWV数据分析表格汇总.xlsx
- Markdown报告: output/reports/PWV数据分析综合报告.md
- Word报告: output/reports/PWV数据分析综合报告.docx
- HTML报告: output/reports/PWV数据分析综合报告.html
- 图表目录: output/image (共 56 张图表)
============================================================

流程成功结束。
[SUCCESS] 2025-05-15 20:28:09 - ==============================================
[SUCCESS] 2025-05-15 20:28:09 - PWV数据分析流程已完成！
[SUCCESS] 2025-05-15 20:28:09 - ==============================================
[INFO] 2025-05-15 20:28:09 - 生成的报告及结果位于:
[INFO] 2025-05-15 20:28:09 - - Markdown报告: output/reports/PWV数据分析综合报告.md
[INFO] 2025-05-15 20:28:09 - - Word报告: output/reports/PWV数据分析综合报告.docx
[INFO] 2025-05-15 20:28:09 - - HTML报告: output/reports/PWV数据分析综合报告.html
[INFO] 2025-05-15 20:28:09 - - Excel数据表: output/tables/
[INFO] 2025-05-15 20:28:09 - - 图表: output/figures/ 和 output/image/
[INFO] 2025-05-15 20:28:09 - ==============================================
