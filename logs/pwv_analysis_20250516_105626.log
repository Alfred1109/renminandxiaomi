[INFO] 2025-05-16 10:56:26 - ==============================================
[INFO] 2025-05-16 10:56:26 - PWV数据分析工具 - 运行脚本
[INFO] 2025-05-16 10:56:26 - 基于小米可穿戴设备进行动脉硬化筛查与脑卒中风险预测研究
[INFO] 2025-05-16 10:56:26 - ==============================================
[INFO] 2025-05-16 10:56:26 - 检测到虚拟环境venv
[INFO] 2025-05-16 10:56:26 - 检测到pyenv，切换到Python 3.12.9...
[SUCCESS] 2025-05-16 10:56:26 - 使用Python: Python 3.12.9
[SUCCESS] 2025-05-16 10:56:26 - 使用Python: Python 3.12.9
[INFO] 2025-05-16 10:56:26 - 激活虚拟环境...
[SUCCESS] 2025-05-16 10:56:26 - 虚拟环境已激活
[INFO] 2025-05-16 10:56:26 - 记录虚拟环境包信息...
cloudpickle==3.1.1
contourpy==1.3.2
cycler==0.12.1
et_xmlfile==2.0.0
fonttools==4.58.0
joblib==1.5.0
kaleido==0.2.1
kiwisolver==1.4.8
llvmlite==0.44.0
lxml==5.4.0
Markdown==3.8
matplotlib==3.10.3
narwhals==1.39.0
numba==0.61.2
numpy==2.2.5
nvidia-nccl-cu12==2.26.5
openpyxl==3.1.5
packaging==25.0
pandas==2.2.3
patsy==1.0.1
pillow==11.2.1
plotly==6.0.1
# Editable Git install with no remote (pwv_analysis==2.0.0)
-e /home/alfred/renminandxiaomi
pyparsing==3.2.3
python-dateutil==2.9.0.post0
python-docx==1.1.2
pytz==2025.2
scikit-learn==1.6.1
scipy==1.15.3
seaborn==0.13.2
shap==0.47.2
six==1.17.0
slicer==0.0.8
statsmodels==0.14.4
threadpoolctl==3.6.0
tqdm==4.67.1
typing_extensions==4.13.2
tzdata==2025.2
xgboost==3.0.1
[INFO] 2025-05-16 10:56:26 - 分析脚本检查通过
[INFO] 2025-05-16 10:56:26 - ==============================================
[INFO] 2025-05-16 10:56:26 - 开始运行PWV数据分析流程...
[INFO] 2025-05-16 10:56:26 - 注意: 这个过程可能需要几分钟时间，请耐心等待...
[INFO] 2025-05-16 10:56:26 - ==============================================
2025-05-16 10:56:27,585 - INFO - data_visualization - fix_chinese_font_display - 检测到WSL环境，将尝试使用Windows字体
2025-05-16 10:56:27,587 - INFO - data_visualization - fix_chinese_font_display - 找到Windows字体目录: /mnt/c/Windows/Fonts
2025-05-16 10:56:27,588 - INFO - data_visualization - fix_chinese_font_display - 找到Windows中文字体: /mnt/c/Windows/Fonts/simhei.ttf
2025-05-16 10:56:27,591 - INFO - font_config - enhance_plot_style - 图表样式增强设置完成
2025-05-16 10:56:27,625 - INFO - font_config - configure_chinese_fonts - 检测到WSL2环境
2025-05-16 10:56:27,625 - INFO - font_config - configure_chinese_fonts - WSL2环境：尝试访问Windows字体目录
2025-05-16 10:56:27,626 - INFO - font_config - configure_chinese_fonts - 找到Windows字体目录: /mnt/c/Windows/Fonts
2025-05-16 10:56:27,626 - INFO - font_config - configure_chinese_fonts - 找到Windows中文字体: /mnt/c/Windows/Fonts/simhei.ttf
2025-05-16 10:56:27,694 - INFO - font_config - configure_chinese_fonts - 成功使用WSL下的Windows字体: SimHei
2025-05-16 10:56:27,694 - INFO - font_config - enhance_plot_style - 图表样式增强设置完成
2025-05-16 10:56:27,694 - INFO - data_visualization - fix_chinese_font_display - 检测到WSL环境，将尝试使用Windows字体
2025-05-16 10:56:27,695 - INFO - data_visualization - fix_chinese_font_display - 找到Windows字体目录: /mnt/c/Windows/Fonts
2025-05-16 10:56:27,695 - INFO - data_visualization - fix_chinese_font_display - 找到Windows中文字体: /mnt/c/Windows/Fonts/simhei.ttf
2025-05-16 10:56:27,711 - INFO - data_visualization - fix_chinese_font_display - 检测到WSL环境，将尝试使用Windows字体
2025-05-16 10:56:27,712 - INFO - data_visualization - fix_chinese_font_display - 找到Windows字体目录: /mnt/c/Windows/Fonts
2025-05-16 10:56:27,712 - INFO - data_visualization - fix_chinese_font_display - 找到Windows中文字体: /mnt/c/Windows/Fonts/simhei.ttf
2025-05-16 10:56:27,712 - INFO - font_config - enhance_plot_style - 图表样式增强设置完成
2025-05-16 10:56:27,821 - INFO - data_processing - load_and_prepare_data - ===== 开始加载和准备数据 =====
2025-05-16 10:56:27,968 - INFO - data_processing - load_and_prepare_data - 原始数据加载成功: 222 行, 77 列
2025-05-16 10:56:27,968 - INFO - data_processing - clean_data - 原始数据: 222 行, 77 列
2025-05-16 10:56:27,969 - INFO - data_processing - clean_data - 列名已标准化
2025-05-16 10:56:27,971 - INFO - data_processing - clean_data - 性别字段处理完成: 男性映射为1 (104), 女性映射为0 (118). Post-map NaNs: 0
2025-05-16 10:56:27,979 - WARNING - data_processing - clean_data - 列 'creatinine_umol_l' 中有 2 个值低于临床范围最小值 20 umol/L
2025-05-16 10:56:27,979 - WARNING - data_processing - clean_data - 列 'urea_mmol_l' (原名: 尿素（mmol/L）) 在转换为数值类型时引入了新的NaN值 (原类型: object).
2025-05-16 10:56:27,979 - WARNING - data_processing - clean_data - 列 'urea_mmol_l' 中有 2 个值低于临床范围最小值 1 mmol/L
2025-05-16 10:56:27,979 - WARNING - data_processing - clean_data - 列 'wbc_10_9' 中有 2 个值低于临床范围最小值 1 10^9/L
2025-05-16 10:56:27,980 - WARNING - data_processing - clean_data - 列 'hb_g_l' 中有 6 个值低于临床范围最小值 50 g/L
2025-05-16 10:56:27,980 - WARNING - data_processing - clean_data - 列 'ef_percent' 中有 37 个值低于临床范围最小值 10 %
2025-05-16 10:56:27,981 - INFO - data_processing - clean_data - 开始处理缺失值。当前总缺失值数量: 4826
2025-05-16 10:56:27,982 - INFO - data_processing - clean_data - 删除PWV值缺失的行: 1 行被删除。剩余 221 行
2025-05-16 10:56:27,983 - INFO - data_processing - clean_data - 列 'cfpwv_speed' 中 15 个缺失值已用中位数 9.25 填充
2025-05-16 10:56:27,983 - INFO - data_processing - clean_data - 列 'bapwv_right_speed' 中 8 个缺失值已用中位数 11.10 填充
2025-05-16 10:56:27,984 - INFO - data_processing - clean_data - 列 'bapwv_left_speed' 中 9 个缺失值已用中位数 11.30 填充
2025-05-16 10:56:27,984 - INFO - data_processing - clean_data - 列 'cfpwv_carotid_si' 中 90 个缺失值已用中位数 9.62 填充
2025-05-16 10:56:27,985 - INFO - data_processing - clean_data - 列 'cfpwv_carotid_ri' 中 92 个缺失值已用中位数 0.42 填充
2025-05-16 10:56:27,985 - INFO - data_processing - clean_data - 列 'creatinine_umol_l' 中 131 个缺失值已用中位数 68.50 填充
2025-05-16 10:56:27,985 - INFO - data_processing - clean_data - 列 'urea_mmol_l' 中 132 个缺失值已用中位数 5.30 填充
2025-05-16 10:56:27,985 - INFO - data_processing - clean_data - 列 'crp_mg_l' 中 131 个缺失值已用中位数 0.40 填充
2025-05-16 10:56:27,986 - INFO - data_processing - clean_data - 列 'ef_percent' 中 131 个缺失值已用中位数 60.25 填充
2025-05-16 10:56:27,986 - INFO - data_processing - clean_data - 列 'abi_right_pt_index' 中 13 个缺失值已用中位数 1.09 填充
2025-05-16 10:56:27,986 - INFO - data_processing - clean_data - 列 'cfpwv_interval_ms' 中 16 个缺失值已用中位数 78.00 填充
2025-05-16 10:56:27,987 - INFO - data_processing - clean_data - 列 'cfpwv_distance_cm' 中 16 个缺失值已用中位数 72.00 填充
2025-05-16 10:56:27,987 - INFO - data_processing - clean_data - 列 'bapwv_right_distance_cm' 中 8 个缺失值已用中位数 110.00 填充
2025-05-16 10:56:27,987 - INFO - data_processing - clean_data - 列 'bapwv_left_interval_ms' 中 10 个缺失值已用中位数 90.00 填充
2025-05-16 10:56:27,987 - INFO - data_processing - clean_data - 列 'abi_right_brachial_index' 中 18 个缺失值已用中位数 1.00 填充
2025-05-16 10:56:27,988 - INFO - data_processing - clean_data - 列 'bfv_carotid_mean_speed' 中 56 个缺失值已用中位数 13.10 填充
2025-05-16 10:56:27,988 - INFO - data_processing - clean_data - 列 'bnp_pg_ml' 中 131 个缺失值已用中位数 26.50 填充
2025-05-16 10:56:27,988 - INFO - data_processing - clean_data - 列 'wbc_10_9' 中 131 个缺失值已用中位数 5.60 填充
2025-05-16 10:56:27,988 - INFO - data_processing - clean_data - 列 'hb_g_l' 中 131 个缺失值已用中位数 131.50 填充
2025-05-16 10:56:27,988 - INFO - data_processing - clean_data - 额外处理PWV相关列 'cfPWV-颈动脉-DAIX ' (不在主要数值列列表中)
2025-05-16 10:56:27,989 - INFO - data_processing - clean_data - PWV相关列 'cfPWV-颈动脉-DAIX ' 中 88 个缺失值已用中位数 0.57 填充
2025-05-16 10:56:27,989 - INFO - data_processing - clean_data - 额外处理PWV相关列 'cfPWV-股动脉-SI ' (不在主要数值列列表中)
2025-05-16 10:56:27,989 - INFO - data_processing - clean_data - PWV相关列 'cfPWV-股动脉-SI ' 中 45 个缺失值已用中位数 5.33 填充
2025-05-16 10:56:27,989 - INFO - data_processing - clean_data - 额外处理PWV相关列 'cfPWV-股动脉-RI' (不在主要数值列列表中)
2025-05-16 10:56:27,989 - INFO - data_processing - clean_data - PWV相关列 'cfPWV-股动脉-RI' 中 57 个缺失值已用中位数 0.02 填充
2025-05-16 10:56:27,989 - INFO - data_processing - clean_data - 额外处理PWV相关列 'cfPWV-股动脉-DAIX ' (不在主要数值列列表中)
2025-05-16 10:56:27,990 - INFO - data_processing - clean_data - PWV相关列 'cfPWV-股动脉-DAIX ' 中 45 个缺失值已用中位数 0.99 填充
2025-05-16 10:56:27,990 - INFO - data_processing - clean_data - 额外处理PWV相关列 'baPWV-右侧-时间间隔ms' (不在主要数值列列表中)
2025-05-16 10:56:27,991 - INFO - data_processing - clean_data - PWV相关列 'baPWV-右侧-时间间隔ms' 中 9 个缺失值已用中位数 92.00 填充
2025-05-16 10:56:27,991 - INFO - data_processing - clean_data - 额外处理PWV相关列 'baPWV-左侧-距离cm' (不在主要数值列列表中)
2025-05-16 10:56:27,991 - INFO - data_processing - clean_data - PWV相关列 'baPWV-左侧-距离cm' 中 8 个缺失值已用中位数 110.00 填充
2025-05-16 10:56:27,992 - INFO - data_processing - clean_data - 缺失值处理完成：总缺失值 4826 -> 3257
2025-05-16 10:56:27,992 - INFO - data_processing - clean_data - 标准化性别编码...
2025-05-16 10:56:27,994 - INFO - data_processing - clean_data - 性别分布 (0=女, 1=男, NaN=未识别/缺失): 
gender
0    117
1    104
Name: count, dtype: int64
2025-05-16 10:56:27,994 - INFO - data_processing - clean_data - 计算BMI...
2025-05-16 10:56:27,995 - INFO - data_processing - clean_data - BMI计算完成，平均BMI: 24.84 (初步)
2025-05-16 10:56:27,995 - INFO - data_processing - clean_data - 列 'sbp': 1 个值被识别为特定范围异常值 (<80 or >200)，将设为NaN。
2025-05-16 10:56:27,996 - INFO - data_processing - clean_data - 列 'sbp' 中的 1 个NaN值 (含转换的异常值) 已用中位数 128.00 填充。
2025-05-16 10:56:27,996 - INFO - data_processing - clean_data - 已创建脉压差列. 平均值: 50.96
2025-05-16 10:56:27,997 - INFO - data_processing - clean_data - PWV range check details (from CLINICAL_RANGES) are available in the summary.
2025-05-16 10:56:27,998 - INFO - data_processing - clean_data - 已删除 1 个全为NaN的列: ['其他']
2025-05-16 10:56:27,998 - INFO - data_processing - clean_data - 数据清洗完成: 221 行 -> 221 行 (100.0% 保留)
2025-05-16 10:56:27,999 - INFO - data_processing - clean_data - 数据清洗摘要已保存到: /home/alfred/renminandxiaomi/output/tables/data_cleaning_summary_20250516_105627.json
2025-05-16 10:56:27,999 - INFO - data_processing - load_and_prepare_data - 
# 数据清洗报告

- 原始数据行数: 222

- 清洗后数据行数: 221


## 列处理详情:

| 列名 (原始) | 列名 (标准化) | 类型转换 | NaN处理 (前) | NaN处理 (后) | NaN填充方法 | 范围检查 | IQR异常值 |

|---|---|---|---|---|---|---|---|

| 提交时间 | 提交时间 | 成功 | 0 | N/A | 无 | 未检查 | 未应用 |

| 填写ID | 填写ID | 成功 | 0 | N/A | 无 | 未检查 | 未应用 |

| 答题时间 | 答题时间 | 成功 | 0 | N/A | 无 | 未检查 | 未应用 |

| 昵称 | 昵称 | 成功 | 0 | N/A | 无 | 未检查 | 未应用 |

| 受试者-编号 | 受试者-编号 | 成功 | 0 | N/A | 无 | 未检查 | 未应用 |

| 受试者-性别 | gender | 成功 | 0 | N/A | 无 | 无 | 未应用 |

| 基础信息-身高 | height | 成功 | 0 | N/A | 无 | 0 低 / 0 高 (范围: 50-250) | 未应用 |

| 基础信息-体重 | weight | 成功 | 0 | N/A | 无 | 0 低 / 0 高 (范围: 10-300) | 未应用 |

| 基础信息-年龄 | age | 成功 | 0 | N/A | 无 | 0 低 / 0 高 (范围: 1-110) | 未应用 |

| 收缩压 | sbp | 成功 | 0 | N/A | 无 | 0 低 / 0 高 (范围: 60-300) | 未应用 |

| 舒张压 | dbp | 成功 | 0 | N/A | 无 | 0 低 / 0 高 (范围: 30-200) | 未应用 |

| 其他信息（相关既往病史，没有可直接跳过） | 其他信息（相关既往病史，没有可直接跳过） | 成功 | 139 | N/A | 无 | 未检查 | 未应用 |

| 备注信息 | 备注信息 | 成功 | 113 | N/A | 无 | 未检查 | 未应用 |

| 入组受试者的诊断状态 | 入组受试者的诊断状态 | 成功 | 217 | N/A | 无 | 未检查 | 未应用 |

| 手表佩戴手 | 手表佩戴手 | 成功 | 10 | N/A | 无 | 未检查 | 未应用 |

| 竞品信息-脉搏波传导速度 | pwv | 成功 | 1 | N/A | 无 | 0 低 / 0 高 (范围: 3-25) | 未应用 |

| 竞品信息-心率变异性 | hrv_index | 成功 | 1 | N/A | 无 | 0 低 / 0 高 (范围: 0-200) | 未应用 |

| 竞品信息-动脉弹性评级 | 竞品信息-动脉弹性评级 | 成功 | 2 | N/A | 无 | 未检查 | 未应用 |

| 小米-手表采集记录 | 小米-手表采集记录 | 成功 | 0 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-颈动脉-SI  | cfpwv_carotid_si | 成功 | 91 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-颈动脉-RI  | cfpwv_carotid_ri | 成功 | 93 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-颈动脉-DAIX  | cfPWV-颈动脉-DAIX  | 成功 | 89 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-速度m/s | cfpwv_speed | 成功 | 16 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-时间间隔ms | cfpwv_interval_ms | 成功 | 17 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-距离cm | cfpwv_distance_cm | 成功 | 17 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-股动脉-SI  | cfPWV-股动脉-SI  | 成功 | 46 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-股动脉-RI | cfPWV-股动脉-RI | 成功 | 58 | N/A | 无 | 未检查 | 未应用 |

| cfPWV-股动脉-DAIX  | cfPWV-股动脉-DAIX  | 成功 | 46 | N/A | 无 | 未检查 | 未应用 |

| baPWV-右侧-距离cm | bapwv_right_distance_cm | 成功 | 9 | N/A | 无 | 未检查 | 未应用 |

| baPWV-右侧-时间间隔ms | baPWV-右侧-时间间隔ms | 成功 | 10 | N/A | 无 | 未检查 | 未应用 |

| baPWV-右侧-速度m/s | bapwv_right_speed | 成功 | 9 | N/A | 无 | 未检查 | 未应用 |

| baPWV-左侧-距离cm | baPWV-左侧-距离cm | 成功 | 9 | N/A | 无 | 未检查 | 未应用 |

| baPWV-左侧-时间间隔ms | bapwv_left_interval_ms | 成功 | 11 | N/A | 无 | 未检查 | 未应用 |

| baPWV-左侧-速度m/s | bapwv_left_speed | 成功 | 10 | N/A | 无 | 未检查 | 未应用 |

| ABI-右侧-肱血压 | ABI-右侧-肱血压 | 成功 | 18 | N/A | 无 | 未检查 | 未应用 |

| ABI-右侧-肱指数 | abi_right_brachial_index | 成功 | 18 | N/A | 无 | 未检查 | 未应用 |

| ABI-右侧-足背血压 | ABI-右侧-足背血压 | 成功 | 17 | N/A | 无 | 未检查 | 未应用 |

| ABI-右侧-足背指数 | ABI-右侧-足背指数 | 成功 | 17 | N/A | 无 | 未检查 | 未应用 |

| ABI-右侧-胫后血压 | ABI-右侧-胫后血压 | 成功 | 13 | N/A | 无 | 未检查 | 未应用 |

| ABI-右侧-胫后指数 | abi_right_pt_index | 成功 | 13 | N/A | 无 | 未检查 | 未应用 |

| ABI-左侧-肱血压 | ABI-左侧-肱血压 | 成功 | 11 | N/A | 无 | 未检查 | 未应用 |

| ABI-左侧-肱指数 | ABI-左侧-肱指数 | 成功 | 12 | N/A | 无 | 未检查 | 未应用 |

| ABI-左侧-足背血压 | ABI-左侧-足背血压 | 成功 | 17 | N/A | 无 | 未检查 | 未应用 |

| ABI-左侧-足背指数 | ABI-左侧-足背指数 | 成功 | 17 | N/A | 无 | 未检查 | 未应用 |

| ABI-左侧-胫后血压 | ABI-左侧-胫后血压 | 成功 | 12 | N/A | 无 | 未检查 | 未应用 |

| ABI-左侧-胫后指数 | ABI-左侧-胫后指数 | 成功 | 12 | N/A | 无 | 未检查 | 未应用 |

| 血流速度-颈部-最高速度m/s | 血流速度-颈部-最高速度m/s | 成功 | 55 | N/A | 无 | 未检查 | 未应用 |

| 血流速度-颈部-最低速度m/s | 血流速度-颈部-最低速度m/s | 成功 | 56 | N/A | 无 | 未检查 | 未应用 |

| 血流速度-颈部-平均速度m/s | bfv_carotid_mean_speed | 成功 | 57 | N/A | 无 | 未检查 | 未应用 |

| 血流速度-腕部-最高速度m/s | 血流速度-腕部-最高速度m/s | 成功 | 25 | N/A | 无 | 未检查 | 未应用 |

| 血流速度-腕部-最低速度m/s | 血流速度-腕部-最低速度m/s | 成功 | 25 | N/A | 无 | 未检查 | 未应用 |

| 血流速度-腕部-平均速度m/s | 血流速度-腕部-平均速度m/s | 成功 | 25 | N/A | 无 | 未检查 | 未应用 |

| 住院号 | 住院号 | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| 性别 | 性别 | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| 既往病史 | 既往病史 | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| 药物治疗 | 药物治疗 | 成功 | 133 | N/A | 无 | 未检查 | 未应用 |

| 血管相关疾病 | 血管相关疾病 | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| CRP（mg/L） | crp_mg_l | 成功 | 132 | N/A | 无 | 0 低 / 0 高 (范围: 0-300) | 未应用 |

| PCT（ng/ml） | PCT（ng/ml） | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| TnI（pg/ml） | TnI（pg/ml） | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| CK-MB（ng/ml） | CK-MB（ng/ml） | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| 肌红蛋白（ng/ml） | 肌红蛋白（ng/ml） | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| BNP（pg/ml） | bnp_pg_ml | 成功 | 132 | N/A | 无 | 0 低 / 0 高 (范围: 0-5000) | 未应用 |

| 肌酐（umol/L） | creatinine_umol_l | 成功 | 132 | N/A | 无 | 2 低 / 0 高 (范围: 20-1000) | 未应用 |

| 尿素（mmol/L） | urea_mmol_l | 成功 | 132 | N/A | 无 | 2 低 / 0 高 (范围: 1-50) | 未应用 |

| WBC(10^9) | wbc_10_9 | 成功 | 132 | N/A | 无 | 2 低 / 0 高 (范围: 1-50) | 未应用 |

| RBC(10^9) | RBC(10^9) | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| Hb（g/L） | hb_g_l | 成功 | 132 | N/A | 无 | 6 低 / 0 高 (范围: 50-250) | 未应用 |

| PLT(10^9) | PLT(10^9) | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| PT | PT | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| APTT | APTT | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| D-dimer | D-dimer | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| 射血分数（%） | ef_percent | 成功 | 132 | N/A | 无 | 37 低 / 0 高 (范围: 10-90) | 未应用 |

| 颈动脉超声 | 颈动脉超声 | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| 肾动脉超声 | 肾动脉超声 | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| 下肢血管超声 | 下肢血管超声 | 成功 | 132 | N/A | 无 | 未检查 | 未应用 |

| 其他 | 其他 | 成功 | 222 | N/A | 无 | 未检查 | 未应用 |


## 性别字段处理:

- '男' (或变体) 映射为 1: 104次

- '女' (或变体) 映射为 0: 118次

- 性别字段映射前NaN数量: 0

- 性别字段映射后NaN数量: 0


--- End of Report ---

2025-05-16 10:56:28,007 - INFO - data_processing - load_and_prepare_data - 数据准备完成。最终数据: 221 行, 91 列
2025-05-16 10:56:28,007 - INFO - data_processing - load_and_prepare_data - ===== 数据加载和准备结束 =====
🚀 PWV数据分析流程启动于: 2025-05-16 10:56:27
============================================================
ℹ️ 当前工作目录: /home/alfred/renminandxiaomi
ℹ️ 项目根目录: /home/alfred/renminandxiaomi

创建输出目录...
✅ 主要输出目录已在 'output' 下创建/确认。

-------------------- 步骤1: 数据加载与预处理 --------------------
找到最新数据文件: docs/excel/pwv数据采集表 -去公式.xlsx
正在加载数据文件: docs/excel/pwv数据采集表 -去公式.xlsx
成功加载数据: 222 行, 77 列

开始创建派生特征...
已创建年龄段特征
已创建血压分类特征，分布: 
bp_category
正常血压     55
1级高血压    54
正常高值     50
高值血压     47
2级高血压     8
低血压       4
3级高血压     3
Name: count, dtype: int64
已创建PWV分类特征，分布: 
pwv_category
偏高    98
边缘    82
正常    41
Name: count, dtype: int64
已创建总风险得分，平均值: 1.77
已创建风险等级特征
已添加cfPWV标记列
已添加baPWV标记列
创建 ABI 风险分类 (基于 abi_right_pt_index)...
ABI风险分类分布: 
abi_risk_category
重度PAD       1
中度PAD       1
轻度PAD       8
正常/临界     199
血管不可压缩     12
Name: count, dtype: int64
派生特征创建完成，现有特征总数: 91
✅ 数据加载和预处理完成。
  加载数据形状: (221, 91)

-------------------- 步骤2: 基础数据分析 --------------------

======== 开始PWV数据分析 ========

计算基本统计指标...
基本统计指标计算完成

分析性别差异...
性别差异分析完成

分析年龄组差异...
注意: 未找到'年龄组'列，尝试创建...
年龄组分析完成

计算变量相关性...
相关性分析完成

执行PWV回归分析...
PWV回归分析完成 (线性模型):
PWV回归分析完成

检测异常值...
异常值检测完成

分析成对测量数据...
成对测量数据分析完成

分析ABI风险组差异...
ABI风险组分析完成。

分析分类变量间的关联性 (卡方检验)...

  检验: 性别与血压分级 (gender vs bp_category)
  列联表:
bp_category  1级高血压  2级高血压  3级高血压  低血压  正常血压  正常高值  高值血压
gender                                                 
0               29      5      2    3    32    21    25
1               25      3      1    1    23    29    22
    警告: 42.9% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 4.3241, P值: 0.6329, 自由度: 6
    关联性是否显著 (P < 0.05): 否

  检验: 性别与PWV分级 (gender vs pwv_category)
  列联表:
pwv_category  偏高  正常  边缘
gender                  
0             48  31  38
1             50  10  44
    卡方统计量: 10.5076, P值: 0.0052, 自由度: 2
    关联性是否显著 (P < 0.05): 是

  检验: 性别与ABI风险分级 (gender vs abi_risk_category)
  列联表:
abi_risk_category  正常/临界  轻度PAD  中度PAD  重度PAD  血管不可压缩
gender                                               
0                    107      5      0      0       5
1                     92      3      1      1       7
    警告: 60.0% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 3.2104, P值: 0.5233, 自由度: 4
    关联性是否显著 (P < 0.05): 否

  检验: 血压分级与PWV分级 (bp_category vs pwv_category)
  列联表:
pwv_category  偏高  正常  边缘
bp_category             
1级高血压         31  10  13
2级高血压          4   0   4
3级高血压          3   0   0
低血压            0   1   3
正常血压          12  16  27
正常高值          26   8  16
高值血压          22   6  19
    警告: 42.9% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 27.5823, P值: 0.0064, 自由度: 12
    关联性是否显著 (P < 0.05): 是

  检验: 血压分级与ABI风险分级 (bp_category vs abi_risk_category)
  列联表:
abi_risk_category  正常/临界  轻度PAD  中度PAD  重度PAD  血管不可压缩
bp_category                                          
1级高血压                 48      2      0      1       3
2级高血压                  8      0      0      0       0
3级高血压                  3      0      0      0       0
低血压                    4      0      0      0       0
正常血压                  51      0      1      0       3
正常高值                  41      5      0      0       4
高值血压                  44      1      0      0       2
    警告: 85.7% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 16.7442, P值: 0.8594, 自由度: 24
    关联性是否显著 (P < 0.05): 否

  检验: PWV分级与ABI风险分级 (pwv_category vs abi_risk_category)
  列联表:
abi_risk_category  正常/临界  轻度PAD  中度PAD  重度PAD  血管不可压缩
pwv_category                                         
偏高                    86      5      0      1       6
正常                    40      0      0      0       1
边缘                    73      3      1      0       5
    警告: 73.3% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 6.1825, P值: 0.6268, 自由度: 8
    关联性是否显著 (P < 0.05): 否

  检验: 年龄组与血压分级 (age_group vs bp_category)
  列联表:
bp_category  1级高血压  2级高血压  3级高血压  低血压  正常血压  正常高值  高值血压
age_group                                              
青少年              0      0      0    0     0     1     0
青年               3      0      1    3    15     9     5
中年              10      2      0    0    20    11    10
老年              34      4      2    1    17    23    25
高龄               7      2      0    0     3     6     7
    警告: 54.3% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 40.0322, P值: 0.0212, 自由度: 24
    关联性是否显著 (P < 0.05): 是

  检验: 年龄组与PWV分级 (age_group vs pwv_category)
  列联表:
pwv_category  偏高  正常  边缘
age_group               
青少年            1   0   0
青年             9   9  18
中年             7  21  25
老年            62  10  34
高龄            19   1   5
    警告: 26.7% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 53.1621, P值: 0.0000, 自由度: 8
    关联性是否显著 (P < 0.05): 是

  检验: 年龄组与ABI风险分级 (age_group vs abi_risk_category)
  列联表:
abi_risk_category  正常/临界  轻度PAD  中度PAD  重度PAD  血管不可压缩
age_group                                            
青少年                    1      0      0      0       0
青年                    33      0      0      0       3
中年                    52      1      0      0       0
老年                    90      7      1      1       7
高龄                    23      0      0      0       2
    警告: 80.0% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 12.2515, P值: 0.7265, 自由度: 16
    关联性是否显著 (P < 0.05): 否

  检验: 综合风险等级与血压分级 (risk_level vs bp_category)
  列联表:
bp_category  1级高血压  2级高血压  3级高血压  低血压  正常血压  正常高值  高值血压
risk_level                                             
低风险              1      0      0    2    22     4     9
中低风险             6      0      0    2    20    15    14
中高风险            17      3      1    0    10    16    15
高风险             30      5      2    0     3    15     9
    警告: 42.9% 的单元格期望频数 < 5。卡方检验结果可能不可靠。
    卡方统计量: 77.3353, P值: 0.0000, 自由度: 18
    关联性是否显著 (P < 0.05): 是

  检验: 综合风险等级与PWV分级 (risk_level vs pwv_category)
  列联表:
pwv_category  偏高  正常  边缘
risk_level              
低风险            0  21  17
中低风险           6  12  39
中高风险          33   6  23
高风险           59   2   3
    卡方统计量: 138.1186, P值: 0.0000, 自由度: 6
    关联性是否显著 (P < 0.05): 是

分类变量关联性分析完成。

======== PWV数据分析完成 ========
✅ 基础数据分析完成。

保存分析结果到 output/tables/PWV_Core_Analysis_Results.xlsx...
  已保存 'basic_stats' 到工作表 'basic_stats'
  已保存 'gender_comparison' 到工作表 'gender_comparison'
  已保存 'age_group_stats' 到工作表 'age_group_stats'
  已保存 'age_group_tests_summary' 到工作表 'age_group_tests_summary'
  已保存 'correlation_analysis' 到工作表 'correlation_analysis'
  已保存 'pwv_regression' 到工作表 'pwv_regression'
  已保存 'pwv_model_stats' 到工作表 'pwv_model_stats'
  已保存 'paired_measurements' 到工作表 'paired_measurements'
  已保存 'paired_analysis' 到工作表 'paired_analysis'
  已保存 'abi_risk_group_stats' 到工作表 'abi_risk_group_stats'
  已保存 'abi_risk_group_anova' 到工作表 'abi_risk_group_anova'
  已保存 'categorical_associations' 到工作表 'categorical_associations'
✅ 分析结果已保存到: output/tables/PWV_Core_Analysis_Results.xlsx
  核心分析结果已保存到: output/tables/PWV_Core_Analysis_Results.xlsx

-------------------- 步骤3: 高级数据分析 --------------------

开始执行高级分析...

BMI分类统计:
bmi分类
偏瘦     7
正常    88
超重    89
肥胖    37
Name: count, dtype: int64

BMI分类百分比:
bmi分类
偏瘦     3.167421
正常    39.819005
超重    40.271493
肥胖    16.742081
Name: proportion, dtype: float64

血压状态分类统计:
血压状态
正常血压      59
正常高值     125
高血压1级     36
高血压2级      1
Name: count, dtype: int64

血压状态分类百分比:
血压状态
正常血压     26.696833
正常高值     56.561086
高血压1级    16.289593
高血压2级     0.452489
Name: proportion, dtype: float64

按 bmi分类 进行子群体分析...

bmi分类子群体统计描述:
            pwv                             ...        age                         
           mean       std count  min   max  ...       mean        std count min max
bmi分类                                       ...                                    
偏瘦     8.042857  1.695934     7  6.3  11.2  ...  42.714286  21.437617     7  22  78
正常     9.378409  1.758686    88  6.3  12.5  ...  58.352273  15.993562    88  25  84
超重     9.702247  1.764098    89  6.8  13.3  ...  60.370787  14.986647    89  25  89
肥胖     9.564865  1.704278    37  6.4  12.3  ...  58.351351  16.784941    37  18  83

[4 rows x 20 columns]

age 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj   lower    upper  reject
0     偏瘦     正常   15.6380  0.0622 -0.5369  31.8129   False
1     偏瘦     肥胖   15.6371  0.0830 -1.3394  32.6135   False
2     偏瘦     超重   17.6565  0.0262  1.4883  33.8247    True
3     正常     肥胖   -0.0009  1.0000 -8.0711   8.0693   False
4     正常     超重    2.0185  0.8333 -4.1733   8.2104   False
5     肥胖     超重    2.0194  0.9158 -6.0373  10.0762   False

组间差异检验结果:
    变量   检验类型       统计量        P值
0  pwv  ANOVA  2.171716  0.092303
1  sbp  ANOVA  1.428282  0.235425
2  dbp  ANOVA  1.863321  0.136747
3  age  ANOVA  2.702926  0.046444

按 血压状态 进行子群体分析...

血压状态子群体统计描述:
             pwv                        ...        age              
            mean       std count   min  ...        std count min max
血压状态                                    ...                         
正常血压    8.393220  1.530367    59   6.3  ...  16.265567    59  22  84
正常高值    9.800800  1.651856   125   6.4  ...  15.523863   125  18  89
高血压1级  10.177778  1.711993    36   7.1  ...  12.069902    36  35  78
高血压2级  12.300000       NaN     1  12.3  ...        NaN     1  77  77

[4 rows x 20 columns]

pwv 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj   lower   upper  reject
0   正常血压   正常高值    1.4076  0.0000  0.7409  2.0743    True
1   正常血压  高血压1级    1.7846  0.0000  0.8919  2.6772    True
2   正常血压  高血压2级    3.9068  0.0847 -0.3498  8.1634   False
3   正常高值  高血压1级    0.3770  0.6133 -0.4214  1.1754   False
4   正常高值  高血压2级    2.4992  0.4232 -1.7386  6.7370   False
5  高血压1级  高血压2级    2.1222  0.5741 -2.1570  6.4014   False

sbp 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj    lower    upper  reject
0   正常血压   正常高值   23.2018  0.0000  18.6979  27.7056    True
1   正常血压  高血压1级   38.6069  0.0000  32.5765  44.6372    True
2   正常血压  高血压2级   52.7458  0.0000  23.9912  81.5003    True
3   正常高值  高血压1级   15.4051  0.0000  10.0117  20.7985    True
4   正常高值  高血压2级   29.5440  0.0402   0.9162  58.1718    True
5  高血压1级  高血压2级   14.1389  0.5854 -14.7684  43.0462   False

dbp 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj    lower    upper  reject
0   正常血压   正常高值    9.2895  0.0000   5.4790  13.1000    True
1   正常血压  高血压1级   11.6139  0.0000   6.5119  16.7159    True
2   正常血压  高血压2级   -6.8305  0.8862 -31.1584  17.4974   False
3   正常高值  高血压1级    2.3244  0.5519  -2.2387   6.8876   False
4   正常高值  高血压2级  -16.1200  0.3142 -40.3406   8.1006   False
5  高血压1级  高血压2级  -18.4444  0.2095 -42.9015   6.0127   False

age 的事后多重比较 (Tukey HSD):
  group1 group2  meandiff   p-adj    lower    upper  reject
0   正常血压   正常高值   10.9769  0.0000   4.7491  17.2048    True
1   正常血压  高血压1级   14.4614  0.0001   6.1228  22.8000    True
2   正常血压  高血压2级   27.0169  0.2960 -12.7442  66.7781   False
3   正常高值  高血压1级    3.4844  0.6214  -3.9734  10.9423   False
4   正常高值  高血压2级   16.0400  0.7207 -23.5458  55.6258   False
5  高血压1级  高血压2级   12.5556  0.8482 -27.4167  52.5279   False

组间差异检验结果:
    变量   检验类型         统计量            P值
0  pwv  ANOVA   13.539320  3.942220e-08
1  sbp  ANOVA  105.503815  3.719014e-42
2  dbp  ANOVA   17.280373  4.245513e-10
3  age  ANOVA    9.549573  5.972170e-06

执行统计功效分析: pwv by gender...

功效分析结果:
   目标功效  效应量 (Cohen's d)  当前样本量  达到目标功效所需样本量   当前统计功效
0  0.80         0.050185    221        12511  0.06589
1  0.85         0.050185    221        14311  0.06589
2  0.90         0.050185    221        16748  0.06589
3  0.95         0.050185    221        20712  0.06589

执行聚类分析...
❌ 高级数据分析过程中发生错误: "['收缩压', '舒张压'] not in index"。部分后续步骤可能受影响。

-------------------- 步骤4: 临床风险分析 --------------------

开始执行临床分析...

执行PWV风险分类...

PWV风险分类统计:
PWV风险
正常      213
边缘        6
显著风险      2
Name: count, dtype: int64

PWV风险分类百分比:
PWV风险
正常      96.380090
边缘       2.714932
显著风险     0.904977
Name: proportion, dtype: float64

计算综合风险评分...
已创建'high_comprehensive_risk_flag'特征。分布:
high_comprehensive_risk_flag
0    0.547511
1    0.452489
Name: proportion, dtype: float64

综合风险评分统计:
count    221.000000
mean       3.529412
std        1.848290
min        0.000000
25%        2.500000
50%        3.500000
75%        5.000000
max        8.000000
Name: 综合风险评分, dtype: float64

综合风险等级统计:
综合风险等级
中等风险    77
高风险     69
低风险     44
极高风险    31
Name: count, dtype: int64

综合风险等级百分比:
综合风险等级
中等风险    34.841629
高风险     31.221719
低风险     19.909502
极高风险    14.027149
Name: proportion, dtype: float64

计算10年心血管疾病风险评分...

10年CVD风险统计:
count    221.000000
mean       4.490498
std        2.539318
min        1.000000
25%        2.300000
50%        4.700000
75%        6.700000
max       13.300000
Name: 10年CVD风险(%), dtype: float642025-05-16 10:56:40,635 - INFO - category - update - Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.
2025-05-16 10:56:40,638 - INFO - category - update - Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.


CVD风险等级统计:
CVD风险等级
低风险     140
中等风险     77
高风险       4
极高风险      0
Name: count, dtype: int64

CVD风险等级百分比:
CVD风险等级
低风险     63.348416
中等风险    34.841629
高风险      1.809955
极高风险     0.000000
Name: proportion, dtype: float64

年龄组与CVD风险等级交叉分析 (%):
CVD风险等级         低风险       中等风险       高风险
年龄组                                     
<30      100.000000   0.000000  0.000000
30-39    100.000000   0.000000  0.000000
40-49    100.000000   0.000000  0.000000
50-59     96.428571   3.571429  0.000000
60-69     58.461538  41.538462  0.000000
70+       22.058824  72.058824  5.882353

高风险人群特征分析:
             age  gender        bmi         sbp       dbp        pwv
count   4.000000     4.0   4.000000    4.000000   4.00000   4.000000
mean   78.750000     1.0  25.967423  146.750000  73.50000  12.150000
std     6.849574     0.0   0.522743    7.041543   7.72442   0.866025
min    75.000000     1.0  25.259516  141.000000  69.00000  11.000000
25%    75.000000     1.0  25.743111  143.250000  69.00000  11.900000
50%    75.500000     1.0  26.081947  144.500000  70.00000  12.250000
75%    79.250000     1.0  26.306259  148.000000  74.50000  12.500000
max    89.000000     1.0  26.446281  157.000000  85.00000  13.100000

临床分析完成！
✅ 临床风险分析完成。
  临床分析结果已保存到: output/tables/PWV_Clinical_Analysis_Results.xlsx

-------------------- 步骤5.5: 创建通用衍生特征 (供风险预测使用) --------------------
创建衍生特征以增强风险预测...
已创建'pulse_pressure' (脉压)特征
已创建'mean_arterial_pressure' (平均动脉压)特征
已创建'age_squared' (年龄_平方)特征
已创建'age_group_code' (年龄分组编码)特征
已创建'bmi_category_code' (BMI分类编码)特征
已创建'weight_group_code' (体重分组编码)特征
已创建'bp_category_code' (血压分类编码)特征: 0=正常, 1=高值, 2=1级高血压, 3=2级及以上高血压
已创建'age_sbp_interaction' (年龄x收缩压交互)特征
已创建'bmi_sbp_interaction' (BMIx收缩压交互)特征
创建了 9 个新特征
✅ 通用衍生特征创建完成。

-------------------- 步骤6: 基础数据可视化 --------------------

======== 开始生成数据可视化 ========
✅ 输出目录已创建/确认

绘制分布直方图...
- 已保存 pwv 分布图: output/figures/distribution/distribution_pwv.png
- 已保存 age 分布图: output/figures/distribution/distribution_age.png
- 已保存 sbp 分布图: output/figures/distribution/distribution_sbp.png
- 已保存 dbp 分布图: output/figures/distribution/distribution_dbp.png
- 已保存 bmi 分布图: output/figures/distribution/distribution_bmi.png
- 已保存 height 分布图: output/figures/distribution/distribution_height.png
- 已保存 weight 分布图: output/figures/distribution/distribution_weight.png
- 已保存 cfpwv_speed 分布图: output/figures/distribution/distribution_cfpwv_speed.png
- 已保存 bapwv_right_speed 分布图: output/figures/distribution/distribution_bapwv_right_speed.png
- 已保存 bapwv_left_speed 分布图: output/figures/distribution/distribution_bapwv_left_speed.png
- 已保存 cfpwv_carotid_si 分布图: output/figures/distribution/distribution_cfpwv_carotid_si.png
- 已保存 cfpwv_carotid_ri 分布图: output/figures/distribution/distribution_cfpwv_carotid_ri.png
- 已保存 hrv_index 分布图: output/figures/distribution/distribution_hrv_index.png
- 已保存 creatinine_umol_l 分布图: output/figures/distribution/distribution_creatinine_umol_l.png
- 已保存 urea_mmol_l 分布图: output/figures/distribution/distribution_urea_mmol_l.png
- 已保存 crp_mg_l 分布图: output/figures/distribution/distribution_crp_mg_l.png
- 已保存 ef_percent 分布图: output/figures/distribution/distribution_ef_percent.png
- 已保存 abi_right_pt_index 分布图: output/figures/distribution/distribution_abi_right_pt_index.png
- 已保存 cfpwv_interval_ms 分布图: output/figures/distribution/distribution_cfpwv_interval_ms.png
- 已保存 cfpwv_distance_cm 分布图: output/figures/distribution/distribution_cfpwv_distance_cm.png
- 已保存 bapwv_right_distance_cm 分布图: output/figures/distribution/distribution_bapwv_right_distance_cm.png
- 已保存 bapwv_left_interval_ms 分布图: output/figures/distribution/distribution_bapwv_left_interval_ms.png
- 已保存 abi_right_brachial_index 分布图: output/figures/distribution/distribution_abi_right_brachial_index.png
- 已保存 bfv_carotid_mean_speed 分布图: output/figures/distribution/distribution_bfv_carotid_mean_speed.png
- 已保存 bnp_pg_ml 分布图: output/figures/distribution/distribution_bnp_pg_ml.png
- 已保存 wbc_10_9 分布图: output/figures/distribution/distribution_wbc_10_9.png
- 已保存 hb_g_l 分布图: output/figures/distribution/distribution_hb_g_l.png

绘制箱线图...
  已保存: overall_boxplot.png
  已保存: pwv_by_gender_boxplot.png
  已保存: pwv_by_年龄组_boxplot.png
  已保存: pwv_by_bmi分类_boxplot.png
  已保存: pwv_by_血压状态_boxplot.png

绘制相关性热力图...
  已保存: correlation_heatmap.png
  已保存: correlation_clustermap.png

绘制性别差异图...
  已保存: pwv_gender_comparison.png
  已保存: age_gender_comparison.png
  已保存: sbp_gender_comparison.png
  已保存: dbp_gender_comparison.png
  已保存: bmi_gender_comparison.png
  已保存: height_gender_comparison.png
  已保存: weight_gender_comparison.png
  已保存: cfpwv_speed_gender_comparison.png
  已保存: bapwv_right_speed_gender_comparison.png
  已保存: bapwv_left_speed_gender_comparison.png
  已保存: cfpwv_carotid_si_gender_comparison.png
  已保存: cfpwv_carotid_ri_gender_comparison.png
  已保存: hrv_index_gender_comparison.png
  已保存: creatinine_umol_l_gender_comparison.png
  已保存: urea_mmol_l_gender_comparison.png
  已保存: crp_mg_l_gender_comparison.png
  已保存: ef_percent_gender_comparison.png
  已保存: abi_right_pt_index_gender_comparison.png
  已保存: cfpwv_interval_ms_gender_comparison.png
  已保存: cfpwv_distance_cm_gender_comparison.png
  已保存: bapwv_right_distance_cm_gender_comparison.png
  已保存: bapwv_left_interval_ms_gender_comparison.png
  已保存: abi_right_brachial_index_gender_comparison.png
  已保存: bfv_carotid_mean_speed_gender_comparison.png
  已保存: bnp_pg_ml_gender_comparison.png
  已保存: wbc_10_9_gender_comparison.png
  已保存: hb_g_l_gender_comparison.png

绘制年龄组分析图...
  已保存: pwv_by_age_group_boxplot.png
  已保存: pwv_by_age_group_trend.png
  已保存: age_group_distribution.png

绘制PWV回归分析图...
  已保存: pwv_age_regression.png
  已保存: pwv_sbp_regression.png
  已保存: pwv_dbp_regression.png
  已保存: pwv_bmi_regression.png
  已保存: pwv_hrv_index_regression.png
  已保存: pwv_crp_mg_l_regression.png
  已保存: pwv_bnp_pg_ml_regression.png
  已保存: pwv_wbc_10_9_regression.png
  已保存: pwv_hb_g_l_regression.png
  已保存: pwv_ef_percent_regression.png
  已保存: pwv_creatinine_umol_l_regression.png
  已保存: pwv_abi_right_brachial_index_regression.png
  已保存: pwv_cfpwv_carotid_si_regression.png
  已保存: pwv_cfpwv_carotid_ri_regression.png
  已保存: pwv_bfv_carotid_mean_speed_regression.png
  已保存: pwv_age_gender_regression.png

======== 数据可视化完成，共生成 80 个图表 ========
图表已按类型保存在 output/figures 各子目录中
✅ 基础数据可视化完成，共生成 80 个图表。
  图表保存在: output/image

-------------------- 步骤7: 增强数据可视化 --------------------

开始创建增强可视化图表...

创建高级热力图: pwv by age & bmi

创建风险评估可视化...

创建子群体可视化...

共创建了 20 个增强可视化图表，保存在 output/image 目录中
✅ 增强数据可视化完成，共生成 20 个图表。
  图表保存在: output/image

-------------------- 步骤8: 风险预测分析 --------------------

--- 开始对 PWV超标风险 进行风险预测 ---2025-05-16 10:56:55,239 - INFO - feature_engineering - prepare_features_and_target - Target is 'cfpwv_speed', excluding raw 'pwv' and other direct cfPWV measures from features to prevent leakage.


==== 开始风险预测: PWV超标风险 ====

准备特征和目标变量 (目标: cfpwv_speed)...
将数值目标 'cfpwv_speed' 转换为二分类 (阈值: 10.0, 条件: >=阈值为1)
  分类分布: 0 (正常/低风险): 148, 1 (超标/高风险): 73
信息: 预定义关键特征 'abi_value' 不在DataFrame中，将不会被包含在特征集。
自动选择了 72 个特征
特征形状: (221, 72), 目标形状: (221,)
目标类型: 分类
特征列: 受试者-编号, gender, height, weight, age, sbp, dbp, hrv_index, cfpwv_carotid_si, cfpwv_carotid_ri, bapwv_right_distance_cm, bapwv_right_speed, baPWV-左侧-距离cm, bapwv_left_interval_ms, bapwv_left_speed, ABI-右侧-肱血压, abi_right_brachial_index, ABI-右侧-足背血压, ABI-右侧-足背指数, ABI-右侧-胫后血压, abi_right_pt_index, ABI-左侧-肱血压, ABI-左侧-肱指数, ABI-左侧-足背血压, ABI-左侧-足背指数, ABI-左侧-胫后血压, ABI-左侧-胫后指数, 血流速度-颈部-最高速度m/s, 血流速度-颈部-最低速度m/s, bfv_carotid_mean_speed, 血流速度-腕部-最高速度m/s, 血流速度-腕部-最低速度m/s, 血流速度-腕部-平均速度m/s, crp_mg_l, PCT（ng/ml）, TnI（pg/ml）, CK-MB（ng/ml）, 肌红蛋白（ng/ml）, bnp_pg_ml, creatinine_umol_l, urea_mmol_l, wbc_10_9, RBC(10^9), hb_g_l, PLT(10^9), PT, APTT, D-dimer, ef_percent, bmi, 脉压差, age_risk, sbp_risk, gender_risk, bmi_risk, pwv_risk, risk_score, has_cfpwv, has_bapwv, high_comprehensive_risk_flag, 基础风险分数, 血压评分, PWV评分, pulse_pressure, mean_arterial_pressure, age_squared, bp_category_code, age_sbp_interaction, bmi_sbp_interaction, age_group_code, bmi_category_code, weight_group_code
警告: 24 个特征含有缺失值，模型训练时将进行处理
ABI-右侧-肱血压          18
ABI-右侧-足背血压         17
ABI-右侧-足背指数         17
ABI-右侧-胫后血压         13
ABI-左侧-肱血压          11
ABI-左侧-肱指数          12
ABI-左侧-足背血压         17
ABI-左侧-足背指数         17
ABI-左侧-胫后血压         12
ABI-左侧-胫后指数         12
血流速度-颈部-最高速度m/s     54
血流速度-颈部-最低速度m/s     55
血流速度-腕部-最高速度m/s     25
血流速度-腕部-最低速度m/s     25
血流速度-腕部-平均速度m/s     25
PCT（ng/ml）         131
TnI（pg/ml）         131
CK-MB（ng/ml）       131
肌红蛋白（ng/ml）        131
RBC(10^9)          131
PLT(10^9)          131
PT                 131
APTT               131
D-dimer            131
dtype: int64
训练集: (165, 72), 测试集: (56, 72)
选择的模型类型: xgboost_classifier
检测到 1118 个缺失值，将进行处理
任务类型: 二分类, 样本数: 165
训练集: 132样本, 验证集: 33样本
创建XGBoost二分类模型
正在训练模型...
训练集准确率: 1.0000, 验证集准确率: 0.6667
警告: 可能存在过拟合
模型训练完成
在 测试集 上的评估指标 (PWV超标风险): {'accuracy': 0.6071428571428571, 'f1': 0.42105263157894735, 'precision': 0.4, 'recall': 0.4444444444444444, 'roc_auc': np.float64(0.6257309941520468)}

可视化模型 'PWV超标风险' 的性能...
ROC曲线已保存: output/image/风险预测/PWV超标风险/PWV超标风险_roc_curve.png
PR曲线已保存: output/image/风险预测/PWV超标风险/PWV超标风险_pr_curve.png
混淆矩阵已保存: output/image/风险预测/PWV超标风险/PWV超标风险_confusion_matrix.png

准备SHAP解释器和计算SHAP值...
使用TreeExplainer for XGBoost模型
正在计算SHAP值...
SHAP值计算完成。
SHAP值数组形状: (56, 72)
DEBUG: run_risk_prediction - About to call visualize_shap_values for PWV超标风险
  X_shap_sample.shape: (56, 72)
  X_shap_sample is DataFrame, empty: False
DEBUG: Entering visualize_shap_values for model: PWV超标风险
  Initial X_sample shape: (56, 72)
  Initial X_sample is DataFrame, empty: False
  DEBUG_SHAP_CHECK: SHAP_AVAILABLE: True, explainer is None: False, shap_values is None: False
DEBUG: Set plt.rcParams['font.sans-serif'] to: ['SimHei', 'Arial', 'Liberation Sans', 'DejaVu Sans', 'Bitstream Vera Sans', 'sans-serif']

生成SHAP值可视化 for PWV超标风险...
  DEBUG: X_sample is already a DataFrame.
  DEBUG: X_sample_df defined. Is None: False
  X_sample_df shape after processing: (56, 72)
SHAP摘要图 (Beeswarm) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_summary_beeswarm.png
SHAP条形图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_summary_bar.png
---- Debugging SHAP Waterfall Plot Texts ----
Attempting to apply font: SimHei
  XTickLabel 0: '$ = 1.423$' - Original Font: DejaVu Sans, New Font: SimHei
  XTickLabel 1: '$ = 1.423$' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 0: '53 other features' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 1: '41.8 = 血流速度-腕部-最高速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 2: '9.1 = 血流速度-腕部-平均速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 3: '1.33 = ABI-左侧-胫后指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 4: '120 = bapwv_right_distance_cm' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 5: '145 = ABI-右侧-足背血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 6: '1.24 = ABI-右侧-足背指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 7: '49 = pulse_pressure' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 8: '156 = ABI-左侧-胫后血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 9: '175 = height' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 10: '117 = ABI-左侧-肱血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 11: 'nan = TnI（pg/ml）' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 12: '14.6 = bapwv_right_speed' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 13: 'nan = 血流速度-颈部-最高速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 14: '0.4 = crp_mg_l' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 15: '49 = 脉压差' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 16: '21.224 = bmi' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 17: '81.6 = age_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 18: '25.469 = bmi_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 19: '11 = 基础风险分数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 20: '53 other features' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 21: ' 血流速度-腕部-最高速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 22: ' 血流速度-腕部-平均速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 23: ' ABI-左侧-胫后指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 24: ' bapwv_right_distance_cm' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 25: ' ABI-右侧-足背血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 26: ' ABI-右侧-足背指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 27: ' pulse_pressure' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 28: ' ABI-左侧-胫后血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 29: ' height' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 30: ' ABI-左侧-肱血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 31: ' TnI（pg/ml）' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 32: ' bapwv_right_speed' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 33: ' 血流速度-颈部-最高速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 34: ' crp_mg_l' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 35: ' 脉压差' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 36: ' bmi' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 37: ' age_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 38: ' bmi_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 39: ' 基础风险分数' - Original Font: DejaVu Sans, New Font: SimHei
---- End Debugging SHAP Waterfall Plot Texts ----
SHAP瀑布图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_waterfall_sample_0.png
SHAP依赖图 (基础风险分数) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_基础风险分数.png
SHAP依赖图 (bmi_sbp_interaction) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_bmi_sbp_interaction.png
SHAP依赖图 (age_sbp_interaction) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_age_sbp_interaction.png
SHAP依赖图 (bmi) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_bmi.png
SHAP依赖图 (crp_mg_l) 已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_dependence_crp_mg_l.png
DEBUG: Before Individual Force Plot:
  shap_values_sample_for_plot is None: False
  shap_values_sample_for_plot.shape: (72,)
  current_base_value_for_sample is None: False
  current_base_value_for_sample: -0.6144388914108276
  type(current_base_value_for_sample): <class 'numpy.float32'>
  X_sample_df.shape: (56, 72)
SHAP力图 (样本 0) 已保存为图片: output/image/风险预测/PWV超标风险/PWV超标风险_shap_force_sample_0.png
DEBUG: Before Multiple Samples HTML Force Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 72)
  expected_value_for_html_force is None: False
  expected_value_for_html_force: -0.6144388914108276
  X_sample_df.shape: (56, 72)
SHAP力图 (多个样本) 已保存为HTML: output/image/风险预测/PWV超标风险/PWV超标风险_shap_force_multiple.html
DEBUG: Before Decision Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 72)
  current_base_value_for_sample is None: False
  current_base_value_for_sample for decision: -0.6144388914108276
  num_samples_for_decision_plot: 5
  X_sample_df.shape: (56, 72)
DEBUG: Inside Decision Plot try, before shape check:
  shap_values_for_decision.shape: (5, 72)
  features_for_decision.shape: (5, 72)
SHAP决策图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_decision_plot.png
DEBUG: Before Heatmap Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 72)
  X_sample_df.shape: (56, 72)
SHAP热力图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_heatmap.png
DEBUG: Before Interaction Plot:
  Calculating SHAP interaction values...
  SHAP interaction values calculated. Type: <class 'numpy.ndarray'>, Shape: (56, 72, 72)
SHAP交互值摘要条形图已保存: output/image/风险预测/PWV超标风险/PWV超标风险_shap_interaction_summary_bar.png
DEBUG: Restored plt.rcParams['font.sans-serif'] to: ['Arial', 'Liberation Sans', 'DejaVu Sans', 'Bitstream Vera Sans', 'sans-serif']
==== 完成风险预测: PWV超标风险 ====

✅ PWV超标风险 的风险预测分析完成。
  为 PWV超标风险 生成了 16 个图表。

--- 开始对 高血压风险 进行风险预测 ---

==== 开始风险预测: 高血压风险 ====

准备特征和目标变量 (目标: bp_category_code)...
将数值目标 'bp_category_code' 转换为二分类 (阈值: 2.0, 条件: >=阈值为1)
  分类分布: 0 (正常/低风险): 92, 1 (超标/高风险): 129
信息: 预定义关键特征 'abi_value' 不在DataFrame中，将不会被包含在特征集。
自动选择了 79 个特征
特征形状: (221, 79), 目标形状: (221,)
目标类型: 分类
特征列: 受试者-编号, gender, height, weight, age, sbp, dbp, pwv, hrv_index, cfpwv_carotid_si, cfpwv_carotid_ri, cfPWV-颈动脉-DAIX , cfpwv_speed, cfpwv_interval_ms, cfpwv_distance_cm, cfPWV-股动脉-SI , cfPWV-股动脉-RI, cfPWV-股动脉-DAIX , bapwv_right_distance_cm, bapwv_right_speed, baPWV-左侧-距离cm, bapwv_left_interval_ms, bapwv_left_speed, ABI-右侧-肱血压, abi_right_brachial_index, ABI-右侧-足背血压, ABI-右侧-足背指数, ABI-右侧-胫后血压, abi_right_pt_index, ABI-左侧-肱血压, ABI-左侧-肱指数, ABI-左侧-足背血压, ABI-左侧-足背指数, ABI-左侧-胫后血压, ABI-左侧-胫后指数, 血流速度-颈部-最高速度m/s, 血流速度-颈部-最低速度m/s, bfv_carotid_mean_speed, 血流速度-腕部-最高速度m/s, 血流速度-腕部-最低速度m/s, 血流速度-腕部-平均速度m/s, crp_mg_l, PCT（ng/ml）, TnI（pg/ml）, CK-MB（ng/ml）, 肌红蛋白（ng/ml）, bnp_pg_ml, creatinine_umol_l, urea_mmol_l, wbc_10_9, RBC(10^9), hb_g_l, PLT(10^9), PT, APTT, D-dimer, ef_percent, bmi, 脉压差, age_risk, sbp_risk, gender_risk, bmi_risk, pwv_risk, risk_score, has_cfpwv, has_bapwv, high_comprehensive_risk_flag, 基础风险分数, 血压评分, PWV评分, pulse_pressure, mean_arterial_pressure, age_squared, age_sbp_interaction, bmi_sbp_interaction, age_group_code, bmi_category_code, weight_group_code
警告: 24 个特征含有缺失值，模型训练时将进行处理
ABI-右侧-肱血压          18
ABI-右侧-足背血压         17
ABI-右侧-足背指数         17
ABI-右侧-胫后血压         13
ABI-左侧-肱血压          11
ABI-左侧-肱指数          12
ABI-左侧-足背血压         17
ABI-左侧-足背指数         17
ABI-左侧-胫后血压         12
ABI-左侧-胫后指数         12
血流速度-颈部-最高速度m/s     54
血流速度-颈部-最低速度m/s     55
血流速度-腕部-最高速度m/s     25
血流速度-腕部-最低速度m/s     25
血流速度-腕部-平均速度m/s     25
PCT（ng/ml）         131
TnI（pg/ml）         131
CK-MB（ng/ml）       131
肌红蛋白（ng/ml）        131
RBC(10^9)          131
PLT(10^9)          131
PT                 131
APTT               131
D-dimer            131
dtype: int64
训练集: (165, 79), 测试集: (56, 79)
选择的模型类型: xgboost_classifier
检测到 1096 个缺失值，将进行处理
任务类型: 二分类, 样本数: 165
训练集: 132样本, 验证集: 33样本
创建XGBoost二分类模型
正在训练模型...
训练集准确率: 1.0000, 验证集准确率: 0.9091
模型训练完成
在 测试集 上的评估指标 (高血压风险): {'accuracy': 0.9821428571428571, 'f1': 0.9846153846153847, 'precision': 1.0, 'recall': 0.9696969696969697, 'roc_auc': np.float64(0.9973649538866931)}

可视化模型 '高血压风险' 的性能...
ROC曲线已保存: output/image/风险预测/高血压风险/高血压风险_roc_curve.png
PR曲线已保存: output/image/风险预测/高血压风险/高血压风险_pr_curve.png
混淆矩阵已保存: output/image/风险预测/高血压风险/高血压风险_confusion_matrix.png

准备SHAP解释器和计算SHAP值...
使用TreeExplainer for XGBoost模型
正在计算SHAP值...
SHAP值计算完成。
SHAP值数组形状: (56, 79)
DEBUG: run_risk_prediction - About to call visualize_shap_values for 高血压风险
  X_shap_sample.shape: (56, 79)
  X_shap_sample is DataFrame, empty: False
DEBUG: Entering visualize_shap_values for model: 高血压风险
  Initial X_sample shape: (56, 79)
  Initial X_sample is DataFrame, empty: False
  DEBUG_SHAP_CHECK: SHAP_AVAILABLE: True, explainer is None: False, shap_values is None: False
DEBUG: Set plt.rcParams['font.sans-serif'] to: ['SimHei', 'Arial', 'Liberation Sans', 'DejaVu Sans', 'Bitstream Vera Sans', 'sans-serif']

生成SHAP值可视化 for 高血压风险...
  DEBUG: X_sample is already a DataFrame.
  DEBUG: X_sample_df defined. Is None: False
  X_sample_df shape after processing: (56, 79)
SHAP摘要图 (Beeswarm) 已保存: output/image/风险预测/高血压风险/高血压风险_shap_summary_beeswarm.png
SHAP条形图已保存: output/image/风险预测/高血压风险/高血压风险_shap_summary_bar.png
---- Debugging SHAP Waterfall Plot Texts ----
Attempting to apply font: SimHei
  XTickLabel 0: '$ = 4.579$' - Original Font: DejaVu Sans, New Font: SimHei
  XTickLabel 1: '$ = 4.579$' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 0: '60 other features' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 1: '72 = ABI-右侧-肱血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 2: '0 = pwv_risk' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 3: '1.29 = abi_right_pt_index' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 4: '1.08 = ABI-右侧-足背指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 5: '109 = baPWV-左侧-距离cm' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 6: '1.06 = ABI-左侧-足背指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 7: '109 = bapwv_right_distance_cm' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 8: '93 = cfpwv_interval_ms' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 9: '23 = age_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 10: '19.9 = 血流速度-腕部-平均速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 11: '0 = high_comprehensive_risk_flag' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 12: '40.9 = 血流速度-腕部-最低速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 13: '88 = ABI-左侧-足背血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 14: '18.195 = bmi_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 15: '7.52 = cfpwv_speed' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 16: '34 = 脉压差' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 17: '58 = dbp' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 18: '69.333 = mean_arterial_pressure' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 19: '92 = sbp' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 20: '60 other features' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 21: ' ABI-右侧-肱血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 22: ' pwv_risk' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 23: ' abi_right_pt_index' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 24: ' ABI-右侧-足背指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 25: ' baPWV-左侧-距离cm' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 26: ' ABI-左侧-足背指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 27: ' bapwv_right_distance_cm' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 28: ' cfpwv_interval_ms' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 29: ' age_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 30: ' 血流速度-腕部-平均速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 31: ' high_comprehensive_risk_flag' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 32: ' 血流速度-腕部-最低速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 33: ' ABI-左侧-足背血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 34: ' bmi_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 35: ' cfpwv_speed' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 36: ' 脉压差' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 37: ' dbp' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 38: ' mean_arterial_pressure' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 39: ' sbp' - Original Font: DejaVu Sans, New Font: SimHei
---- End Debugging SHAP Waterfall Plot Texts ----
SHAP瀑布图已保存: output/image/风险预测/高血压风险/高血压风险_shap_waterfall_sample_0.png
SHAP依赖图 (sbp) 已保存: output/image/风险预测/高血压风险/高血压风险_shap_dependence_sbp.png
SHAP依赖图 (mean_arterial_pressure) 已保存: output/image/风险预测/高血压风险/高血压风险_shap_dependence_mean_arterial_pressure.png
SHAP依赖图 (dbp) 已保存: output/image/风险预测/高血压风险/高血压风险_shap_dependence_dbp.png
SHAP依赖图 (脉压差) 已保存: output/image/风险预测/高血压风险/高血压风险_shap_dependence_脉压差.png
SHAP依赖图 (cfpwv_speed) 已保存: output/image/风险预测/高血压风险/高血压风险_shap_dependence_cfpwv_speed.png
DEBUG: Before Individual Force Plot:
  shap_values_sample_for_plot is None: False
  shap_values_sample_for_plot.shape: (79,)
  current_base_value_for_sample is None: False
  current_base_value_for_sample: 0.36134693026542664
  type(current_base_value_for_sample): <class 'numpy.float32'>
  X_sample_df.shape: (56, 79)
SHAP力图 (样本 0) 已保存为图片: output/image/风险预测/高血压风险/高血压风险_shap_force_sample_0.png
DEBUG: Before Multiple Samples HTML Force Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 79)
  expected_value_for_html_force is None: False
  expected_value_for_html_force: 0.36134693026542664
  X_sample_df.shape: (56, 79)
SHAP力图 (多个样本) 已保存为HTML: output/image/风险预测/高血压风险/高血压风险_shap_force_multiple.html
DEBUG: Before Decision Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 79)
  current_base_value_for_sample is None: False
  current_base_value_for_sample for decision: 0.36134693026542664
  num_samples_for_decision_plot: 5
  X_sample_df.shape: (56, 79)
DEBUG: Inside Decision Plot try, before shape check:
  shap_values_for_decision.shape: (5, 79)
  features_for_decision.shape: (5, 79)
SHAP决策图已保存: output/image/风险预测/高血压风险/高血压风险_shap_decision_plot.png
DEBUG: Before Heatmap Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 79)
  X_sample_df.shape: (56, 79)
SHAP热力图已保存: output/image/风险预测/高血压风险/高血压风险_shap_heatmap.png
DEBUG: Before Interaction Plot:
  Calculating SHAP interaction values...
  SHAP interaction values calculated. Type: <class 'numpy.ndarray'>, Shape: (56, 79, 79)
SHAP交互值摘要条形图已保存: output/image/风险预测/高血压风险/高血压风险_shap_interaction_summary_bar.png
DEBUG: Restored plt.rcParams['font.sans-serif'] to: ['Arial', 'Liberation Sans', 'DejaVu Sans', 'Bitstream Vera Sans', 'sans-serif']
==== 完成风险预测: 高血压风险 ====

✅ 高血压风险 的风险预测分析完成。
  为 高血压风险 生成了 16 个图表。

--- 开始对 高综合风险 进行风险预测 ---

==== 开始风险预测: 高综合风险 ====

准备特征和目标变量 (目标: high_comprehensive_risk_flag)...
信息: 预定义关键特征 'abi_value' 不在DataFrame中，将不会被包含在特征集。
自动选择了 79 个特征
特征形状: (221, 79), 目标形状: (221,)
目标类型: 分类
特征列: 受试者-编号, gender, height, weight, age, sbp, dbp, pwv, hrv_index, cfpwv_carotid_si, cfpwv_carotid_ri, cfPWV-颈动脉-DAIX , cfpwv_speed, cfpwv_interval_ms, cfpwv_distance_cm, cfPWV-股动脉-SI , cfPWV-股动脉-RI, cfPWV-股动脉-DAIX , bapwv_right_distance_cm, bapwv_right_speed, baPWV-左侧-距离cm, bapwv_left_interval_ms, bapwv_left_speed, ABI-右侧-肱血压, abi_right_brachial_index, ABI-右侧-足背血压, ABI-右侧-足背指数, ABI-右侧-胫后血压, abi_right_pt_index, ABI-左侧-肱血压, ABI-左侧-肱指数, ABI-左侧-足背血压, ABI-左侧-足背指数, ABI-左侧-胫后血压, ABI-左侧-胫后指数, 血流速度-颈部-最高速度m/s, 血流速度-颈部-最低速度m/s, bfv_carotid_mean_speed, 血流速度-腕部-最高速度m/s, 血流速度-腕部-最低速度m/s, 血流速度-腕部-平均速度m/s, crp_mg_l, PCT（ng/ml）, TnI（pg/ml）, CK-MB（ng/ml）, 肌红蛋白（ng/ml）, bnp_pg_ml, creatinine_umol_l, urea_mmol_l, wbc_10_9, RBC(10^9), hb_g_l, PLT(10^9), PT, APTT, D-dimer, ef_percent, bmi, 脉压差, age_risk, sbp_risk, gender_risk, bmi_risk, pwv_risk, risk_score, has_cfpwv, has_bapwv, 基础风险分数, 血压评分, PWV评分, pulse_pressure, mean_arterial_pressure, age_squared, bp_category_code, age_sbp_interaction, bmi_sbp_interaction, age_group_code, bmi_category_code, weight_group_code
警告: 24 个特征含有缺失值，模型训练时将进行处理
ABI-右侧-肱血压          18
ABI-右侧-足背血压         17
ABI-右侧-足背指数         17
ABI-右侧-胫后血压         13
ABI-左侧-肱血压          11
ABI-左侧-肱指数          12
ABI-左侧-足背血压         17
ABI-左侧-足背指数         17
ABI-左侧-胫后血压         12
ABI-左侧-胫后指数         12
血流速度-颈部-最高速度m/s     54
血流速度-颈部-最低速度m/s     55
血流速度-腕部-最高速度m/s     25
血流速度-腕部-最低速度m/s     25
血流速度-腕部-平均速度m/s     25
PCT（ng/ml）         131
TnI（pg/ml）         131
CK-MB（ng/ml）       131
肌红蛋白（ng/ml）        131
RBC(10^9)          131
PLT(10^9)          131
PT                 131
APTT               131
D-dimer            131
dtype: int64
训练集: (165, 79), 测试集: (56, 79)
选择的模型类型: xgboost_classifier
检测到 1133 个缺失值，将进行处理
任务类型: 二分类, 样本数: 165
训练集: 132样本, 验证集: 33样本
创建XGBoost二分类模型
正在训练模型...
训练集准确率: 1.0000, 验证集准确率: 0.8485
模型训练完成
在 测试集 上的评估指标 (高综合风险): {'accuracy': 0.875, 'f1': 0.8679245283018868, 'precision': 0.8214285714285714, 'recall': 0.92, 'roc_auc': np.float64(0.9548387096774194)}

可视化模型 '高综合风险' 的性能...
ROC曲线已保存: output/image/风险预测/高综合风险/高综合风险_roc_curve.png
PR曲线已保存: output/image/风险预测/高综合风险/高综合风险_pr_curve.png
混淆矩阵已保存: output/image/风险预测/高综合风险/高综合风险_confusion_matrix.png

准备SHAP解释器和计算SHAP值...
使用TreeExplainer for XGBoost模型
正在计算SHAP值...
SHAP值计算完成。
SHAP值数组形状: (56, 79)
DEBUG: run_risk_prediction - About to call visualize_shap_values for 高综合风险
  X_shap_sample.shape: (56, 79)
  X_shap_sample is DataFrame, empty: False
DEBUG: Entering visualize_shap_values for model: 高综合风险
  Initial X_sample shape: (56, 79)
  Initial X_sample is DataFrame, empty: False
  DEBUG_SHAP_CHECK: SHAP_AVAILABLE: True, explainer is None: False, shap_values is None: False
DEBUG: Set plt.rcParams['font.sans-serif'] to: ['SimHei', 'Arial', 'Liberation Sans', 'DejaVu Sans', 'Bitstream Vera Sans', 'sans-serif']

生成SHAP值可视化 for 高综合风险...
  DEBUG: X_sample is already a DataFrame.
  DEBUG: X_sample_df defined. Is None: False
  X_sample_df shape after processing: (56, 79)
SHAP摘要图 (Beeswarm) 已保存: output/image/风险预测/高综合风险/高综合风险_shap_summary_beeswarm.png
SHAP条形图已保存: output/image/风险预测/高综合风险/高综合风险_shap_summary_bar.png
---- Debugging SHAP Waterfall Plot Texts ----
Attempting to apply font: SimHei
  XTickLabel 0: '$ = 4.177$' - Original Font: DejaVu Sans, New Font: SimHei
  XTickLabel 1: '$ = 4.177$' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 0: '60 other features' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 1: '10.1 = bapwv_right_speed' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 2: '6.36 = cfpwv_speed' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 3: '0.99 = ABI-左侧-胫后指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 4: '160 = height' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 5: '29.5 = 血流速度-腕部-最高速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 6: '112 = ABI-右侧-肱血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 7: '56 = weight' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 8: '1.07 = ABI-左侧-足背指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 9: '21.875 = bmi' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 10: '51.45 = age_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 11: '36.1 = 血流速度-颈部-最高速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 12: '102 = ABI-左侧-肱血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 13: '0 = risk_score' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 14: '7.7 = pwv' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 15: '5.02 = cfPWV-股动脉-SI ' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 16: '65 = dbp' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 17: '78.333 = mean_arterial_pressure' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 18: '105 = sbp' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 19: '22.969 = bmi_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 20: '60 other features' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 21: ' bapwv_right_speed' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 22: ' cfpwv_speed' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 23: ' ABI-左侧-胫后指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 24: ' height' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 25: ' 血流速度-腕部-最高速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 26: ' ABI-右侧-肱血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 27: ' weight' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 28: ' ABI-左侧-足背指数' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 29: ' bmi' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 30: ' age_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 31: ' 血流速度-颈部-最高速度m/s' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 32: ' ABI-左侧-肱血压' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 33: ' risk_score' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 34: ' pwv' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 35: ' cfPWV-股动脉-SI ' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 36: ' dbp' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 37: ' mean_arterial_pressure' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 38: ' sbp' - Original Font: DejaVu Sans, New Font: SimHei
  YTickLabel 39: ' bmi_sbp_interaction' - Original Font: DejaVu Sans, New Font: SimHei
---- End Debugging SHAP Waterfall Plot Texts ----
SHAP瀑布图已保存: output/image/风险预测/高综合风险/高综合风险_shap_waterfall_sample_0.png
SHAP依赖图 (bmi_sbp_interaction) 已保存: output/image/风险预测/高综合风险/高综合风险_shap_dependence_bmi_sbp_interaction.png
SHAP依赖图 (sbp) 已保存: output/image/风险预测/高综合风险/高综合风险_shap_dependence_sbp.png
SHAP依赖图 (mean_arterial_pressure) 已保存: output/image/风险预测/高综合风险/高综合风险_shap_dependence_mean_arterial_pressure.png
SHAP依赖图 (dbp) 已保存: output/image/风险预测/高综合风险/高综合风险_shap_dependence_dbp.png
SHAP依赖图 (cfPWV-股动脉-SI ) 已保存: output/image/风险预测/高综合风险/高综合风险_shap_dependence_cfPWV-股动脉-SI .png
DEBUG: Before Individual Force Plot:
  shap_values_sample_for_plot is None: False
  shap_values_sample_for_plot.shape: (79,)
  current_base_value_for_sample is None: False
  current_base_value_for_sample: -0.21930620074272156
  type(current_base_value_for_sample): <class 'numpy.float32'>
  X_sample_df.shape: (56, 79)
SHAP力图 (样本 0) 已保存为图片: output/image/风险预测/高综合风险/高综合风险_shap_force_sample_0.png
DEBUG: Before Multiple Samples HTML Force Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 79)
  expected_value_for_html_force is None: False
  expected_value_for_html_force: -0.21930620074272156
  X_sample_df.shape: (56, 79)
SHAP力图 (多个样本) 已保存为HTML: output/image/风险预测/高综合风险/高综合风险_shap_force_multiple.html
DEBUG: Before Decision Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 79)
  current_base_value_for_sample is None: FalseTraceback (most recent call last):
  File "/home/alfred/renminandxiaomi/scripts/run_pwv_analysis.py", line 310, in main_orchestrator
    generated_report_paths = generate_all_reports(
                             ^^^^^^^^^^^^^^^^^^^^^
TypeError: generate_all_reports() got an unexpected keyword argument 'figures'

  current_base_value_for_sample for decision: -0.21930620074272156
  num_samples_for_decision_plot: 5
  X_sample_df.shape: (56, 79)
DEBUG: Inside Decision Plot try, before shape check:
  shap_values_for_decision.shape: (5, 79)
  features_for_decision.shape: (5, 79)
SHAP决策图已保存: output/image/风险预测/高综合风险/高综合风险_shap_decision_plot.png
DEBUG: Before Heatmap Plot:
  current_shap_values is None: False
  current_shap_values.shape: (56, 79)
  X_sample_df.shape: (56, 79)
SHAP热力图已保存: output/image/风险预测/高综合风险/高综合风险_shap_heatmap.png
DEBUG: Before Interaction Plot:
  Calculating SHAP interaction values...
  SHAP interaction values calculated. Type: <class 'numpy.ndarray'>, Shape: (56, 79, 79)
SHAP交互值摘要条形图已保存: output/image/风险预测/高综合风险/高综合风险_shap_interaction_summary_bar.png
DEBUG: Restored plt.rcParams['font.sans-serif'] to: ['Arial', 'Liberation Sans', 'DejaVu Sans', 'Bitstream Vera Sans', 'sans-serif']
==== 完成风险预测: 高综合风险 ====

✅ 高综合风险 的风险预测分析完成。
  为 高综合风险 生成了 16 个图表。
  风险预测总共生成 48 个图表。

-------------------- 步骤9: 生成分析报告 --------------------
尝试生成PWV数据分析综合报告...
❌ 报告生成过程中发生错误: generate_all_reports() got an unexpected keyword argument 'figures'
尽管报告生成出现错误，流程将继续尝试完成...

============================================================
🎉 PWV数据分析流程全部完成! (总耗时: 40.38秒)
------------------------- 查看产出 -------------------------
- Excel表格 (核心分析): output/tables/PWV_Core_Analysis_Results.xlsx
- Excel表格 (高级分析): output/tables/PWV_Advanced_Analysis_Results.xlsx
- Excel表格 (临床分析): output/tables/PWV_Clinical_Analysis_Results.xlsx
- Excel表格 (风险预测): output/tables/PWV_Risk_Predictions.xlsx
- Excel表格 (从报告提取): output/tables/PWV数据分析表格汇总.xlsx
- Markdown报告: output/reports/PWV数据分析综合报告.md
- Word报告: output/reports/PWV数据分析综合报告.docx
- HTML报告: output/reports/PWV数据分析综合报告.html
- 图表目录: output/image (共 148 张图表)
============================================================

流程成功结束。
[SUCCESS] 2025-05-16 10:57:08 - ==============================================
[SUCCESS] 2025-05-16 10:57:08 - PWV数据分析流程已完成！
[SUCCESS] 2025-05-16 10:57:08 - ==============================================
[INFO] 2025-05-16 10:57:08 - 生成的报告及结果位于:
[INFO] 2025-05-16 10:57:08 - - Markdown报告: output/reports/PWV数据分析综合报告.md
[INFO] 2025-05-16 10:57:08 - - Word报告: output/reports/PWV数据分析综合报告.docx
[INFO] 2025-05-16 10:57:08 - - HTML报告: output/reports/PWV数据分析综合报告.html
[INFO] 2025-05-16 10:57:08 - - Excel数据表: output/tables/
[INFO] 2025-05-16 10:57:08 - - 图表: output/figures/ 和 output/image/
[INFO] 2025-05-16 10:57:08 - ==============================================
